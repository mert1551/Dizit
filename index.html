<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DİZİT - Film ve Dizi İzleme Platformu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121212;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }
        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .loading-logo {
            font-size: 48px;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
            margin-bottom: 30px;
            animation: glow 2s infinite ease-in-out;
        }
        .popcorn-loader {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100px;
            height: 60px;
        }
        .popcorn {
            position: absolute;
            width: 15px;
            height: 15px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            animation: pop 1.2s infinite ease-in-out;
        }
        .popcorn:nth-child(1) { left: 20px; animation-delay: 0s; }
        .popcorn:nth-child(2) { left: 40px; animation-delay: 0.2s; }
        .popcorn:nth-child(3) { left: 60px; animation-delay: 0.4s; }
        @keyframes pop {
            0%, 100% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-30px) scale(1.2); opacity: 0.7; }
        }
        @keyframes glow {
            0% { text-shadow: 0 0 10px rgba(255, 204, 0, 0.5); }
            50% { text-shadow: 0 0 20px rgba(255, 204, 0, 0.8); }
            100% { text-shadow: 0 0 10px rgba(255, 204, 0, 0.5); }
        }
        /* Premium Icon Styles (mevcut, değiştirilmedi) */
        .premium-icon {
            position: absolute;
            top: 3px;
            right: 3px;
            background: #ffcc00;
            color: #121212;
            padding: 5px;
            border-radius: 50%;
            font-size: 14px;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loading-screen">
        <div class="curtain-container">
            <div class="curtain-left"></div>
            <div class="curtain-right"></div>
        </div>
        <div class="loading-logo">DİZİT</div>
        <div class="popcorn-loader">
            <div class="popcorn"></div>
            <div class="popcorn"></div>
            <div class="popcorn"></div>
        </div>
    </div>

    <header id="header">
        <a href="#" class="logo">DİZİT</a>
        <div class="header-right">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Film veya dizi ara...">
                <button id="search-btn"><i class="fas fa-search"></i></button>
            </div>
            <div class="burger-menu" id="burger-menu">
                <i class="fas fa-bars"></i>
            </div>
        </div>
        <div class="nav-container" id="nav-container">
            <ul class="nav-links">
                <li><a href="filmler.html?type=film">Filmler</a></li>
                <li><a href="diziler.html?type=dizi">Diziler</a></li>
                <li><a href="arama/film-dizi-arama.html">Keşfet</a></li>
                <li><a href="request-complaint.html">İstek ve Şikayet</a></li>
            </ul>
        </div>
        <div class="profile-wrapper">
            <div class="profile-card" onclick="toggleProfileMenu()">
                <img src="/resim/avatar/user.png" alt="Profile Avatar" class="profile-avatar">
                <span class="profile-username"></span>
                <i class="fas fa-chevron-down profile-arrow"></i>
            </div>
            <div class="profile-dropdown" id="profile-dropdown">
                <ul class="profile-menu">
                    <li><a href="hesabim.html"><i class="fas fa-user"></i> Profilim</a></li>
                    <li><a href="ayarlar.html"><i class="fas fa-cog"></i> Ayarlar</a></li>
                    <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Çıkış Yap</a></li>
                </ul>
            </div>
        </div>
    </header>

    <div class="auth-modal" id="auth-modal">
        <div class="auth-modal-content">
            <button class="close-modal" onclick="closeAuthModal()"><i class="fas fa-times"></i></button>
            <div class="auth-tabs">
                <button class="tab-btn active" id="login-tab" onclick="switchTab('login')">Giriş Yap</button>
                <button class="tab-btn" id="signup-tab" onclick="switchTab('signup')">Üye Ol</button>
                <button class="tab-btn" id="forgot-tab" onclick="switchTab('forgot')">Şifremi Unuttum</button>
            </div>
            <div class="auth-form" id="login-form">
                <h2>Giriş Yap</h2>
                <form id="login-form-submit" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="login-username">Kullanıcı Adı</label>
                        <input type="text" id="login-username" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Parola</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <p class="error-message" id="login-error"></p>
                    <button type="submit" class="auth-submit">Giriş Yap</button>
                    <p class="forgot-link" onclick="switchTab('forgot')">Şifrenizi mi unuttunuz?</p>
                </form>
            </div>
            <div class="auth-form" id="signup-form" style="display: none;">
                <h2>Üye Ol</h2>
                <form id="signup-form-submit" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label for="signup-username">Kullanıcı Adı</label>
                        <input type="text" id="signup-username" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-email">E-posta</label>
                        <input type="email" id="signup-email" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Parola</label>
                        <input type="password" id="signup-password" required oninput="validatePassword()">
                        <p class="password-hint" id="password-hint">Parola en az 8 karakter, 1 büyük harf, 1 küçük harf ve 1 rakam içermelidir.</p>
                    </div>
                    <div class="form-group">
                        <label for="signup-password-confirm">Parola Tekrar</label>
                        <input type="password" id="signup-password-confirm" required>
                    </div>
                    <p class="error-message" id="signup-error"></p>
                    <button type="submit" class="auth-submit">Üye Ol</button>
                </form>
            </div>
            <div class="auth-form" id="forgot-form" style="display: none;">
                <h2>Şifremi Unuttum</h2>
                <form id="forgot-form-submit" onsubmit="handleForgotPassword(event)">
                    <div class="form-group">
                        <label for="forgot-email">E-posta</label>
                        <input type="email" id="forgot-email" required>
                    </div>
                    <p class="error-message" id="forgot-error"></p>
                    <p class="success-message" id="forgot-success"></p>
                    <button type="submit" class="auth-submit">Şifre Sıfırlama Bağlantısı Gönder</button>
                </form>
            </div>
        </div>
    </div>
    <div class="search-overlay" id="search-overlay">
        <div class="search-overlay-header">
            <input type="text" id="search-overlay-input" placeholder="Film veya dizi ara...">
            <button id="close-overlay" class="close-overlay-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="search-results" id="search-results"></div>
    </div>

    <main>
        <div class="home-content">
            <section>
                <h2 class="section-title">Yeni Eklenen Filmler</h2>
                <div class="poster-slider" id="new-films-slider">
                    <div class="slider-container" id="new-films-slider-container"></div>
                    <button class="slider-prev" id="new-films-prev"><i class="fas fa-chevron-left"></i></button>
                    <button class="slider-next" id="new-films-next"><i class="fas fa-chevron-right"></i></button>
                </div>
            </section>
            <section>
                <h2 class="section-title">Yeni Eklenen Diziler</h2>
                <div class="poster-slider" id="new-series-slider">
                    <div class="slider-container" id="new-series-slider-container"></div>
                    <button class="slider-prev" id="new-series-prev"><i class="fas fa-chevron-left"></i></button>
                    <button class="slider-next" id="new-series-next"><i class="fas fa-chevron-right"></i></button>
                </div>
            </section>
            <section>
                <h2 class="section-title">Yeni Bölümler</h2>
                <div class="episode-list" id="new-episodes-list"></div>
                <div class="show-all">
                    <button onclick="window.location.href='son-bolumler.html'">Tümünü Göster</button>
                </div>
            </section>
            <section>
                <h2 class="section-title">Tüm Filmler</h2>
                <div class="movie-grid" id="all-films-grid"></div>
                <div class="show-all" id="show-all-films">
                    <button onclick="window.location.href='filmler.html?type=film'">Tümünü Göster</button>
                </div>
            </section>
            <section>
                <h2 class="section-title">Tüm Diziler</h2>
                <div class="movie-grid" id="all-series-grid"></div>
                <div class="show-all" id="show-all-series">
                    <button onclick="window.location.href='diziler.html?type=dizi'">Tümünü Göster</button>
                </div>
            </section>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-column">
                <h3>DİZİT</h3>
                <p>En iyi film ve dizi izleme platformu.</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>© 2025 DİZİT. Tüm hakları saklıdır.</p>
        </div>
    </footer>

    <script>
        let isLoggedIn = !!localStorage.getItem('token');
        let currentUser = localStorage.getItem('username') || null;
        let apiUrl = '';

        async function fetchApiUrl() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                apiUrl = data.apiUrl || 'http://localhost:3000';
            } catch (error) {
                console.error('API URL alınamadı:', error);
                apiUrl = 'http://localhost:3000';
            }
        }


        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function updateProfileAvatar() {
            const profileAvatar = document.querySelector('.profile-avatar');
            const profileUsername = document.querySelector('.profile-username');
            if (!isLoggedIn) {
                profileAvatar.src = '/resim/avatar/user.png';
                profileUsername.textContent = 'Giriş Yap';
                return;
            }
            try {
                const response = await fetch(`${apiUrl}/api/user-profile?t=${Date.now()}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        showToast('Oturumunuzun süresi doldu. Lütfen yeniden giriş yapın.', 'error');
                        localStorage.removeItem('token');
                        localStorage.removeItem('username');
                        isLoggedIn = false;
                        currentUser = null;
                        openAuthModal('login');
                    }
                    throw new Error('Kullanıcı verileri alınamadı');
                }
                const user = await response.json();
                profileAvatar.src = user.avatar || '/resim/avatar/user.png';
                profileAvatar.onerror = () => {
                    profileAvatar.src = '/resim/avatar/user.png';
                };
                profileUsername.textContent = user.username || 'Kullanıcı';
                localStorage.setItem('username', user.username);
            } catch (error) {
                console.error('Profil verileri yüklenemedi:', error);
                profileAvatar.src = '/resim/avatar/user.png';
                profileUsername.textContent = localStorage.getItem('username') || 'Giriş Yap';
            }
        }

        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                isLoggedIn = false;
                currentUser = null;
                await updateProfileAvatar();
                return false;
            }
            try {
                const res = await fetch(`${apiUrl}/api/verify-token`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    isLoggedIn = true;
                    currentUser = data.username;
                    localStorage.setItem('username', data.username);
                    await updateProfileAvatar();
                    return true;
                } else {
                    localStorage.removeItem('token');
                    localStorage.removeItem('username');
                    isLoggedIn = false;
                    currentUser = null;
                    await updateProfileAvatar();
                    return false;
                }
            } catch (error) {
                console.error('Token doğrulama hatası:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                isLoggedIn = false;
                currentUser = null;
                await updateProfileAvatar();
                return false;
            }
        }

        function updateAuthUI() {
            // No longer updating auth-buttons or user-info, as they are removed
        }

        function openAuthModal(type = 'login') {
            const modal = document.getElementById('auth-modal');
            modal.classList.add('active');
            switchTab(type);
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').classList.remove('active');
            document.getElementById('login-error').textContent = '';
            document.getElementById('signup-error').textContent = '';
            document.getElementById('forgot-error').textContent = '';
            document.getElementById('forgot-success').textContent = '';
            document.getElementById('login-form-submit').reset();
            document.getElementById('signup-form-submit').reset();
            document.getElementById('forgot-form-submit').reset();
            document.getElementById('password-hint').style.color = '#666';
        }

        function toggleProfileMenu() {
            const dropdown = document.getElementById('profile-dropdown');
            if (!isLoggedIn) {
                openAuthModal('login');
            } else {
                dropdown.classList.toggle('active');
            }
        }

        function closeProfileMenu() {
            const dropdown = document.getElementById('profile-dropdown');
            dropdown.classList.remove('active');
        }

        function switchTab(type) {
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            const forgotTab = document.getElementById('forgot-tab');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const forgotForm = document.getElementById('forgot-form');
            const loginError = document.getElementById('login-error');
            const signupError = document.getElementById('signup-error');
            const forgotError = document.getElementById('forgot-error');
            const forgotSuccess = document.getElementById('forgot-success');

            loginTab.classList.toggle('active', type === 'login');
            signupTab.classList.toggle('active', type === 'signup');
            forgotTab.classList.toggle('active', type === 'forgot');
            loginForm.style.display = type === 'login' ? 'block' : 'none';
            signupForm.style.display = type === 'signup' ? 'block' : 'none';
            forgotForm.style.display = type === 'forgot' ? 'block' : 'none';
            loginError.textContent = '';
            signupError.textContent = '';
            forgotError.textContent = '';
            forgotSuccess.textContent = '';
            document.getElementById('login-form-submit').reset();
            document.getElementById('signup-form-submit').reset();
            document.getElementById('forgot-form-submit').reset();
            document.getElementById('password-hint').style.color = '#666';
        }

        function validatePassword() {
            const password = document.getElementById('signup-password').value;
            const hint = document.getElementById('password-hint');
            const strongPasswordRegex = /^(?=.*[a-z])(?!.*[ğüşöçı])(?=.*[A-Z])(?!.*[ĞÜŞÖÇİ])(?=.*\d)[A-Za-z\d]{8,}$/;
            if (!strongPasswordRegex.test(password) && password.length > 0) {
                hint.style.color = '#e74c3c';
            } else {
                hint.style.color = '#666';
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            try {
                const res = await fetch(`${apiUrl}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('username', data.username);
                    isLoggedIn = true;
                    currentUser = data.username;
                    errorEl.textContent = '';
                    closeAuthModal();
                    updateAuthUI();
                    await updateProfileAvatar();
                    if (data.isAdmin) {
                        window.location.href = '/admin/admin-panel.html';
                    } else {
                        window.location.reload();
                    }
                } else {
                    errorEl.textContent = data.error || 'Giriş başarısız';
                }
            } catch (error) {
                errorEl.textContent = 'Sunucuyla bağlantı hatası';
                console.error('Giriş hatası:', error);
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            const username = document.getElementById('signup-username').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const passwordConfirm = document.getElementById('signup-password-confirm').value;
            const errorEl = document.getElementById('signup-error');
            const strongPasswordRegex = /^(?=.*[a-z])(?!.*[ğüşöçı])(?=.*[A-Z])(?!.*[ĞÜŞÖÇİ])(?=.*\d)[A-Za-z\d]{8,}$/;

            if (!strongPasswordRegex.test(password)) {
                errorEl.textContent = 'Parola en az 8 karakter, 1 büyük harf, 1 küçük harf ve 1 rakam içermelidir.';
                return;
            }
            if (password !== passwordConfirm) {
                errorEl.textContent = 'Parolalar eşleşmiyor';
                return;
            }
            try {
                const res = await fetch(`${apiUrl}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                const data = await res.json();
                if (res.ok) {
                    const loginRes = await fetch(`${apiUrl}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const loginData = await loginRes.json();
                    if (loginRes.ok) {
                        localStorage.setItem('token', loginData.token);
                        localStorage.setItem('username', loginData.username);
                        isLoggedIn = true;
                        currentUser = loginData.username;
                        closeAuthModal();
                        updateAuthUI();
                        await updateProfileAvatar();
                        window.location.reload();
                    } else {
                        errorEl.textContent = loginData.error || 'Otomatik giriş başarısız';
                    }
                } else {
                    errorEl.textContent = data.error || 'Kayıt başarısız';
                }
            } catch (error) {
                errorEl.textContent = 'Sunucuyla bağlantı hatası';
                console.error('Kayıt hatası:', error);
            }
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            const email = document.getElementById('forgot-email').value;
            const errorEl = document.getElementById('forgot-error');
            const successEl = document.getElementById('forgot-success');
            try {
                const res = await fetch(`${apiUrl}/api/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                if (res.ok) {
                    successEl.textContent = 'Şifre sıfırlama bağlantısı e-postanıza gönderildi.';
                    errorEl.textContent = '';
                } else {
                    errorEl.textContent = data.error || 'Şifre sıfırlama başarısız';
                    successEl.textContent = '';
                }
            } catch (error) {
                errorEl.textContent = 'Sunucuyla bağlantı hatası';
                console.error('Şifre sıfırlama hatası:', error);
                successEl.textContent = '';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            isLoggedIn = false;
            currentUser = null;
            updateAuthUI();
            updateProfileAvatar();
            window.location.href = 'index.html';
        }

        function displayItems(items, containerId, isSlider = true, isEpisode = false) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    if (!items || !Array.isArray(items) || items.length === 0) {
        container.innerHTML = '<p>İçerik bulunamadı.</p>';
        return;
    }

    items.forEach(item => {
        let card;

        if (isEpisode) {
            const seriesTitle = item.seriesTitle || 'Başlık Yok';
            const seasonNumber = item.seasonNumber || 1;
            const episodeNumber = item.episodeNumber || 1;
            const seriesId = item.seriesId || '';
            const episodeDetails = `${seasonNumber}.Sezon ${episodeNumber}.Bölüm`;
            const link = `/dizi/${seriesId}/sezon-${seasonNumber}/bolum-${episodeNumber}`;

            card = document.createElement('div');
            card.className = 'episode-card';
            card.style.cursor = 'pointer';
            card.onclick = () => {
                console.log('Yönlendirme:', link);
                window.location.href = link;
            };

            card.innerHTML = `
                <img src="${item.poster || 'https://via.placeholder.com/60x90'}" alt="${seriesTitle}" class="episode-poster">
                <div class="episode-info">
                    <h3 class="episode-series-title">${seriesTitle}</h3>
                    <div class="episode-details">${episodeDetails}</div>
                </div>
            `;
        } else {
            card = document.createElement('div');
            card.className = isSlider ? 'slider-item' : 'movie-card';

            const title = item.title || 'Başlık Yok';
            const badge = item.language?.includes("Yerli") ? '<span class="language-badge"><img src="resim/flag-tr.png" alt="TR" class="flag-icon"> Yerli</span>' :
                item.language?.includes("Türkçe Dublaj") && item.language?.includes("Türkçe Altyazı") ? '<span class="language-badge"><img src="resim/flag-tr.png" alt="TR" class="flag-icon"> Dublaj <i class="fas fa-closed-captioning"></i> Altyazı</span>' :
                    item.language?.includes("Türkçe Dublaj") ? '<span class="language-badge"><img src="resim/flag-tr.png" alt="TR" class="flag-icon"> Dublaj</span>' :
                        item.language?.includes("Türkçe Altyazı") ? '<span class="language-badge"><i class="fas fa-closed-captioning"></i> Altyazı</span>' : '';
            const premiumIcon = item.premium ? '<i class="fas fa-crown premium-icon"></i>' : '';

            card.innerHTML = `
                <div class="poster-wrapper">
                    <img src="${item.poster || 'https://via.placeholder.com/300x450'}" alt="${title}" class="${isSlider ? 'slider-poster' : 'movie-poster'}">
                    ${badge}
                    ${premiumIcon}
                </div>
                <div class="${isSlider ? 'slider-info' : 'movie-info'}">
                    <h3 class="${isSlider ? 'slider-title' : 'movie-title'}">${title}</h3>
                    <div class="${isSlider ? 'slider-meta' : 'movie-meta'}">
                        <span>${item.year || 'Bilinmiyor'}</span>
                        <div class="imdb-rating">
                            <i class="fas fa-star"></i> ${item.rating || 'N/A'}
                        </div>
                    </div>
                </div>
            `;

            card.onclick = () => {
                window.location.href = item.type === 'dizi' ? `dizi.html?id=${item.id}` : `film.html?id=${item.id}`;
            };
        }

        container.appendChild(card);
    });
}




 let homeMoviesLoaded = false;

async function loadHomeContent() {
    if (homeMoviesLoaded) {
        console.log("Ana sayfa film/dizi içerikleri zaten yüklendi.");
        return;
    }

    const loadingScreen = document.getElementById('loading-screen');
    loadingScreen.classList.remove('hidden'); // Ekranı göster

    try {
        const res = await fetch(`${apiUrl}/api/movies/home`);
        const data = await res.json();

        if (Array.isArray(data.newFilms)) {
            displayItems(data.newFilms, "new-films-slider-container", true);
        }

        if (Array.isArray(data.newSeries)) {
            displayItems(data.newSeries, "new-series-slider-container", true);
        }

        if (Array.isArray(data.latestFilms)) {
            displayItems(data.latestFilms, "all-films-grid", false);
        }

        if (Array.isArray(data.latestSeries)) {
            displayItems(data.latestSeries, "all-series-grid", false);
        }

        homeMoviesLoaded = true;
    } catch (error) {
        console.error("Ana sayfa film/dizi içerikleri yüklenemedi:", error);
        showToast("İçerikler yüklenemedi", "error");
    } finally {
        loadingScreen.classList.add('hidden'); // Ekranı gizle
        setTimeout(() => loadingScreen.remove(), 500);
    }
}




        

        async function fetchMovies(limit = 20) {
            try {
                const response = await fetch(`${apiUrl}/api/movies/home?limit=${limit}&fields=title,title2,type,poster,year,rating,language,premium`);
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                const movies = await response.json();
                console.log('Çekilen filmler:', movies);
                return movies;
            } catch (error) {
                console.error('Filmler alınamadı:', error);
                showToast('İçerikler yüklenemedi', 'error');
                return [];
            }
        }

        async function fetchRecentEpisodes(limit = 6) {
            try {
                const response = await fetch(`${apiUrl}/api/recent-episodes?limit=${limit}&sort=-addedDate&fields=seriesId,seriesTitle,seasonNumber,episodeNumber,year,rating,poster`);
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                const episodes = await response.json();
                console.log('Çekilen bölümler:', episodes);
                return episodes;
            } catch (error) {
                console.error('Yeni bölümler alınamadı:', error);
                showToast('Yeni bölümler yüklenemedi', 'error');
                return [];
            }
        }

        function getNewFilms(movies) {
            return movies.filter(m => m.type === "film").sort((a, b) => (b.year || 0) - (a.year || 0)).slice(0, 10);
        }

        function getNewSeries(movies) {
            return movies.filter(m => m.type === "dizi").sort((a, b) => (b.year || 0) - (a.year || 0)).slice(0, 10);
        }

        function getAllFilms(movies) {
            return movies.filter(m => m.type === "film").slice(0, 12);
        }

        function getAllSeries(movies) {
            return movies.filter(m => m.type === "dizi").slice(0, 12);
        }

        async function updateContent() {
            const episodes = await fetchRecentEpisodes(6);
            if (episodes && Array.isArray(episodes) && episodes.length > 0) {
                displayItems(episodes, 'new-episodes-list', false, true);
            } else {
                document.getElementById('new-episodes-list').innerHTML = '<p>İçerik bulunamadı.</p>';
                console.warn('Gösterilecek bölüm yok');
            }
            // Hide loading screen after content is loaded
            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.classList.add('hidden');
            setTimeout(() => loadingScreen.remove(), 500);
        }

        async function performSearch(query) {
            const searchResults = document.getElementById('search-results');
            if (!query) {
                searchResults.innerHTML = '';
                return;
            }
            try {
                const res = await fetch(`${apiUrl}/api/search?q=${encodeURIComponent(query)}&limit=7&fields=title,title2,type,poster,year,rating,genres,premium`);
                if (!res.ok) throw new Error('Arama başarısız');
                let data = await res.json();
                data = data.filter(item => 
                    item.title?.toLowerCase().includes(query.toLowerCase()) || 
                    item.title2?.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 7);
                console.log('Arama sonuçları:', data);
                displaySearchResults(data);
            } catch (error) {
                searchResults.innerHTML = '<p>Sonuç bulunamadı.</p>';
                showToast('Arama başarısız', 'error');
                console.error('Arama hatası:', error);
            }
        }

        function displaySearchResults(results) {
            const searchResults = document.getElementById('search-results');
            if (!searchResults) return;
            searchResults.innerHTML = results.length ? '' : '<p>Sonuç bulunamadı.</p>';

            results.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'search-result-item';
                const premiumIcon = item.premium ? '<i class="fas fa-crown premium-icon"></i>' : '';
                itemEl.innerHTML = `
                    <div class="poster-wrapper">
                        <img src="${item.poster || 'https://via.placeholder.com/150'}" alt="${item.title}" class="search-result-poster">
                        ${premiumIcon}
                    </div>
                    <div class="search-result-info">
                        <div class="search-result-title">
                            ${item.title || 'Bilinmeyen İçerik'}
                            ${item.title2 ? `<span class="search-result-title2">(${item.title2})</span>` : ''}
                        </div>
                        <div class="search-result-year">${item.year || 'N/A'}</div>
                        <div class="search-result-genres">${Array.isArray(item.genres) ? item.genres.join(', ') : 'N/A'}</div>
                    </div>
                `;
                itemEl.onclick = () => window.location.href = item.type === 'dizi' ? `dizi.html?id=${item.id}` : `film.html?id=${item.id}`;
                searchResults.appendChild(itemEl);
            });
        }

        function initSlider(sliderId, prevBtnId, nextBtnId) {
            const container = document.getElementById(sliderId);
            const prevBtn = document.getElementById(prevBtnId);
            const nextBtn = document.getElementById(nextBtnId);
            let isDragging = false;
            let startX = 0;
            let scrollLeft = 0;

            function updateButtons() {
                prevBtn.style.display = container.scrollLeft <= 0 ? 'none' : 'block';
                nextBtn.style.display = container.scrollLeft >= container.scrollWidth - container.clientWidth - 1 ? 'none' : 'block';
            }

            const scrollStep = 220;
            nextBtn.onclick = () => {
                container.scrollTo({
                    left: container.scrollLeft + scrollStep,
                    behavior: 'smooth'
                });
                setTimeout(updateButtons, 300);
            };

            prevBtn.onclick = () => {
                container.scrollTo({
                    left: container.scrollLeft - scrollStep,
                    behavior: 'smooth'
                });
                setTimeout(updateButtons, 300);
            };

            container.addEventListener('touchstart', e => {
                isDragging = true;
                startX = e.touches[0].clientX;
                scrollLeft = container.scrollLeft;
            });

            container.addEventListener('touchmove', e => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.touches[0].clientX;
                const deltaX = x - startX;
                container.scrollLeft = scrollLeft - deltaX;
            });

            container.addEventListener('touchend', () => {
                isDragging = false;
            });

            container.addEventListener('wheel', e => {
                e.preventDefault();
                container.scrollTo({
                    left: container.scrollLeft + e.deltaY * 2,
                    behavior: 'smooth'
                });
                setTimeout(updateButtons, 200);
            });

            container.addEventListener('scroll', updateButtons);
            updateButtons();
        }

       document.addEventListener('DOMContentLoaded', async () => {
    const loadingScreen = document.getElementById('loading-screen');
    loadingScreen.classList.remove('hidden'); // Yükleme ekranını göster

    await fetchApiUrl();
    await checkAuth();
    await updateContent();     // sadece yeni bölümler
    await loadHomeContent();  // filmler/diziler

    loadingScreen.classList.add('hidden'); // Ekranı gizle
    setTimeout(() => loadingScreen.remove(), 500); // DOM'dan kaldır

    // Sliderlar ve diğer event listener'lar
    initSlider('new-films-slider-container', 'new-films-prev', 'new-films-next');
    initSlider('new-series-slider-container', 'new-series-prev', 'new-series-next');

            const searchInput = document.getElementById('search-input');
            const searchOverlayInput = document.getElementById('search-overlay-input');
            const searchOverlay = document.getElementById('search-overlay');
            const closeOverlayBtn = document.getElementById('close-overlay');

            searchInput.addEventListener('focus', () => {
                searchOverlay.classList.add('active');
                searchOverlayInput.focus();
                searchOverlayInput.value = searchInput.value;
            });

            searchOverlayInput.addEventListener('input', () => performSearch(searchOverlayInput.value.trim().toLowerCase()));

            closeOverlayBtn.addEventListener('click', () => {
                searchOverlay.classList.remove('active');
                searchInput.value = '';
                searchOverlayInput.value = '';
                document.getElementById('search-results').innerHTML = '';
            });

            const burgerMenu = document.getElementById('burger-menu');
            const navContainer = document.getElementById('nav-container');
            burgerMenu.addEventListener('click', () => navContainer.classList.toggle('active'));

            window.addEventListener('resize', () => {
                if (window.innerWidth > 768 && navContainer.classList.contains('active')) {
                    navContainer.classList.remove('active');
                }
            });

            // Close profile dropdown when clicking outside
            document.addEventListener('click', (event) => {
                const dropdown = document.getElementById('profile-dropdown');
                const profileCard = document.querySelector('.profile-card');
                if (!dropdown.contains(event.target) && !profileCard.contains(event.target)) {
                    closeProfileMenu();
                }
            });
        });

        // Close profile dropdown when clicking/tapping outside
        document.addEventListener('click', (event) => {
            const dropdown = document.getElementById('profile-dropdown');
            const profileCard = document.querySelector('.profile-card');
            if (!dropdown.contains(event.target) && !profileCard.contains(event.target)) {
                closeProfileMenu();
            }
        });

        // Handle touch events for mobile devices
        document.addEventListener('touchstart', (event) => {
            const dropdown = document.getElementById('profile-dropdown');
            const profileCard = document.querySelector('.profile-card');
            if (!dropdown.contains(event.target) && !profileCard.contains(event.target)) {
                closeProfileMenu();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93c318ca3b9baff5',t:'MTc0NjY0NTg1OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>