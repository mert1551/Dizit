<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Film/Dizi Düzenle - DİZİT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css">
    <style>
     .form-group input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color, #444);
            border-radius: 4px;
            background: var(--input-bg, #252525);
            cursor: pointer;
            vertical-align: middle;
            position: relative;
            transition: background 0.3s, border-color 0.3s;
        }

        .form-group input[type="checkbox"]:checked {
            background: var(--accent-color, #ffcc00);
            border-color: var(--accent-color, #ffcc00);
        }

        .form-group input[type="checkbox"]:checked::after {
            content: '\f00c'; /* Font Awesome check ikonu */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: var(--primary-bg, #000);
            font-size: 12px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .form-group input[type="checkbox"]:focus {
            outline: none;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 468px) {
            .form-group input[type="checkbox"] {
                width: 18px;
                height: 18px;
            }
            .form-group input[type="checkbox"]:checked::after {
                font-size: 10px;
            }
        }

        @media (max-width: 319px) {
            .form-group input[type="checkbox"] {
                width: 16px;
                height: 16px;
            }
            .form-group input[type="checkbox"]:checked::after {
                font-size: 8px;
            }
        }

        .admin-container {
            max-width: 1200px;
            margin: 80px auto 20px;
            padding: 20px;
        }

        .add-movie-section {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            position: relative;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 8px;
            line-height: 1.4;
            font-size: 0.95rem;
            color: var(--text-color);
            width: 100%;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        .form-group label {
            color: var(--text-color);
            margin-bottom: 8px;
            display: block;
            font-weight: 500;
        }

        .form-group.invalid input,
        .form-group.invalid textarea,
        .form-group.invalid select {
            border-color: #ff5555;
        }

        .form-group .validation-message {
            color: #ff5555;
            font-size: 0.8rem;
            position: absolute;
            bottom: -18px;
            left: 0;
        }

        .preview-section {
            margin-top: 30px;
            padding: 20px;
            background: var(--secondary-bg);
            border-radius: 8px;
        }

        .preview-poster {
            max-width: 200px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .preview-title {
            font-size: 1.5rem;
            color: var(--text-color);
        }

        .preview-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .admin-only-message {
            text-align: center;
            color: #ff5555;
            font-size: 1.2rem;
            padding: 20px;
            background: var(--secondary-bg);
            border-radius: 8px;
        }



        .video-source-entry, .episode-entry {
            border: 1px solid var(--border-color);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .season-container {
            border: 2px solid var(--accent-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background: var(--secondary-bg);
        }

        .season-container h3 {
            margin: 0;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--input-bg);
            border-radius: 5px;
            transition: background 0.3s;
        }

        .season-container h3:hover {
            background: var(--accent-color);
            color: var(--primary-bg);
        }

        .season-container h3::after {
            content: '\f107'; /* Font Awesome aşağı ok */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            transition: transform 0.3s;
        }

        .season-container.active h3::after {
            transform: rotate(180deg);
        }

        .season-content {
            display: none;
            padding-top: 15px;
        }

        .season-container.active .season-content {
            display: block;
        }

        .video-source-entry select, .episode-entry select {
            width: 100%;
        }

        .video-source-entry input, .episode-entry input {
            margin-bottom: 5px;
        }

        .remove-video, .remove-episode, .remove-season {
            background: #ff5555;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
        }

        .remove-video:hover, .remove-episode:hover, .remove-season:hover {
            background: #cc4444;
        }

        #add-video-btn, .add-episode-btn, .add-episode-video-btn, #add-season-btn, #add-genre-btn, .submit-btn ,.delete-btn,.fetch-btn {
            background: var(--accent-color);
            color: var(--primary-bg);
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .delete-btn{
            background: #ff5555;
        }

        #add-video-btn:hover, .add-episode-btn:hover, .add-episode-video-btn:hover, #add-season-btn:hover, #add-genre-btn:hover {
            background: #e6b800;
        }

        .genres-list {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .genre-item {
            background: var(--accent-color);
            color: var(--primary-bg);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .genre-item button {
            background: none;
            border: none;
            color: var(--primary-bg);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0;
        }

        .video-type-custom {
            display: none;
        }

        .video-source-entry .video-type-select option[value="Diğer"]:selected ~ .video-type-custom,
        .video-source-entry .video-type-select option[value="Özel Başlık"]:selected ~ .video-type-custom {
            display: block;
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--secondary-bg);
            color: var(--text-color);
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
        }

        .toast-notification.show {
            display: block;
        }

        @media (max-width: 768px) {
            .admin-container {
                margin-top: 100px;
                padding: 10px;
            }

            .add-movie-section {
                padding: 15px;
            }

            .form-grid, .video-source-entry, .episode-entry {
                grid-template-columns: 1fr;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: 0.9rem;
                padding: 10px;
            }

      

            .form-group label {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 468px) {
      
            .form-group label {
                font-size: 0.7rem;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: 0.75rem;
                padding: 8px;
            }

            .submit-btn, #add-video-btn, .add-episode-btn, .add-episode-video-btn, #add-season-btn, #add-genre-btn, .submit-btn ,.delete-btn,.fetch-btn{
                padding: 8px;
                font-size: 0.8rem;
            }

            .remove-video, .remove-episode, .remove-season {
                padding: 6px;
                font-size: 0.7rem;
            }

            .form-group .validation-message {
                font-size: 0.6rem;
                bottom: -18px;
            }

            .genre-item {
                font-size: 0.7rem;
                padding: 4px 8px;
            }

            .genre-item button {
                font-size: 0.6rem;
            }
        }

        @media (max-width: 319px) {
            .form-group label {
                font-size: 0.5rem;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: 0.65rem;
                padding: 6px;
            }

            .submit-btn, #add-video-btn, .add-episode-btn, .add-episode-video-btn, #add-season-btn, #add-genre-btn , .submit-btn ,.delete-btn{
                padding: 6px;
                font-size: 0.6rem;
            }

            .remove-video, .remove-episode, .remove-season {
                padding: 5px;
                font-size: 0.6rem;
            }

            .form-group .validation-message {
                font-size: 0.5rem;
                bottom: -15px;
            }

            .genre-item {
                font-size: 0.6rem;
                padding: 3px 6px;
            }

            .genre-item button {
                font-size: 0.5rem;
            }
        }
            
    </style>
</head>
<body>
    <header id="header">
        <a href="../index.html" class="logo">DİZİT</a>
        <div class="header-right">
            <div class="burger-menu" id="burger-menu">
                <i class="fas fa-bars"></i>
            </div>
        </div>
        <div class="nav-container" id="nav-container">
            <ul class="nav-links">
                <li><a href="admin-panel.html" class="active">Anasayfa</a></li>
                <li><a href="add-movie.html" class="active">Ekle</a></li>
                <li><a href="edit-movie.html" class="active">Düzenle</a></li>
            </ul>
            <div class="auth-buttons" id="auth-buttons">
                <button class="login-btn" onclick="openAuthModal('login')">Giriş Yap</button>
                <button class="signup-btn" onclick="openAuthModal('signup')">Üye Ol</button>
            </div>
            <div class="user-info" id="user-info" style="display: none;">
                <div class="user-profile">
                    <span class="user-greeting">Merhaba,</span>
                    <span class="username-display" id="username-display"></span>
                </div>
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Çıkış Yap</button>
            </div>
        </div>
    </header>

    <div class="auth-modal" id="auth-modal">
        <div class="auth-modal-content">
            <button class="close-modal" onclick="closeAuthModal()"><i class="fas fa-times"></i></button>
            <div class="auth-tabs">
                <button class="tab-btn active" id="login-tab" onclick="switchTab('login')">Giriş Yap</button>
                <button class="tab-btn" id="signup-tab" onclick="switchTab('signup')">Üye Ol</button>
            </div>
            <div class="auth-form" id="login-form">
                <h2>Giriş Yap</h2>
                <form id="login-form-submit" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="login-username">Kullanıcı Adı</label>
                        <input type="text" id="login-username" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Parola</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <p class="error-message" id="login-error"></p>
                    <button type="submit" class="auth-submit">Giriş Yap</button>
                </form>
            </div>
            <div class="auth-form" id="signup-form" style="display: none;">
                <h2>Üye Ol</h2>
                <form id="signup-form-submit" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label for="signup-username">Kullanıcı Adı</label>
                        <input type="text" id="signup-username" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Parola</label>
                        <input type="password" id="signup-password" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password-confirm">Parola Tekrar</label>
                        <input type="password" id="signup-password-confirm" required>
                    </div>
                    <p class="error-message" id="signup-error"></p>
                    <button type="submit" class="auth-submit">Üye Ol</button>
                </form>
            </div>
        </div>
    </div>

    <main class="admin-container">
        <section class="add-movie-section" id="admin-content" style="display: none;">
            <h2 class="section-title">Film/Dizi Düzenle</h2>
            <form id="movie-form" onsubmit="handleEditMovie(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="movie-id">Film/Dizi ID</label>
                        <input type="text" id="movie-id" placeholder="ID girin (örn: filmTest123)" pattern="[a-zA-Z0-9-$]{1,100}" required>
                        <span class="validation-message" id="movie-id-error"></span>
                    </div>
                    <div class="form-group">
                        <button type="button" class="fetch-btn" onclick="fetchMovieData()">Verileri Getir</button>
                    </div>
                    <div class="form-group">
                        <label for="movie-title">Başlık</label>
                        <input type="text" id="movie-title" required>
                        <span class="validation-message" id="movie-title-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="movie-title2">Alternatif Başlık</label>
                        <input type="text" id="movie-title2">
                    </div>
                    <div class="form-group">
                        <label for="movie-year">Yıl</label>
                        <input type="number" id="movie-year" min="1900" max="2100">
                        <span class="validation-message" id="movie-year-error"></span>
                    </div>
                    <div class="form-group" id="runtime-section">
                        <label for="movie-runtime">Süre (örn: 2 s 10 dk)</label>
                        <input type="text" id="movie-runtime" pattern="^\d+\s*dk$|^\d+\s*s\s*\d+\s*dk$">
                        <span class="validation-message" id="movie-runtime-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="movie-rating">IMDb Puanı (0-10)</label>
                        <input type="number" id="movie-rating" step="0.1" min="0" max="10">
                        <span class="validation-message" id="movie-rating-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="movie-country">Ülke (virgülle ayırın)</label>
                        <input type="text" id="movie-country" placeholder="Türkiye, ABD">
                    </div>
                    <div class="form-group">
                        <label for="movie-language">Dil (virgülle ayırın)</label>
                        <input type="text" id="movie-language" placeholder="Türkçe, İngilizce">
                    </div>
                    <div class="form-group">
                        <label for="movie-genres">Türler (virgülle ayırın)</label>
                        <input type="text" id="movie-genres" placeholder="Aksiyon, Macera">
                    </div>
                    <div class="form-group">
                        <label for="movie-poster">Poster URL</label>
                        <input type="url" id="movie-poster" placeholder="https://example.com/poster.jpg">
                        <span class="validation-message" id="movie-poster-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="movie-type">Tür</label>
                        <select id="movie-type" required>
                            <option value="film">Film</option>
                            <option value="dizi">Dizi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="movie-related-series">İlgili Seri Filmler (ID’ler, virgülle ayırın)</label>
                        <input type="text" id="movie-related-series" placeholder="filmTest123, diziTest456">
                        <span class="validation-message" id="movie-related-series-error"></span>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="movie-plot">Konu</label>
                        <textarea id="movie-plot" rows="4"></textarea>
                    </div>
                    <div class="form-group" id="video-sources-section" style="grid-column: span 2;">
                        <label>Video Kaynakları</label>
                        <div id="video-source-list"></div>
                        <button type="button" id="add-video-btn">Video Kaynağı Ekle</button>
                    </div>
                    <div class="form-group" id="episodes-section" style="display: none; grid-column: span 2;">
                        <label>Sezonlar ve Bölümler</label>
                        <div id="season-list"></div>
                        <button type="button" id="add-season-btn">Yeni Sezon Ekle</button>
                    </div>
                    <div class="form-group">
                        <label for="movie-premium">Premium İçerik</label>
                        <input type="checkbox" id="movie-premium" name="movie-premium">
                    </div>
                    <button type="submit" class="submit-btn">Değişiklikleri Kaydet</button>
                    <button type="button" class="delete-btn" onclick="deleteMovie()">Filmi/Diziyi Sil</button>
                </div>
            </form>
            <div class="preview-section" id="preview-section" style="display: none;">
                <h3>Önizleme</h3>
                <img id="preview-poster" class="preview-poster" src="" alt="Poster Önizleme">
                <h4 id="preview-title" class="preview-title"></h4>
                <p id="preview-meta" class="preview-meta"></p>
                <p id="preview-plot"></p>
            </div>
        </section>
        <div class="admin-only-message" id="admin-only-message" style="display: none;">
            Bu sayfa yalnızca yöneticiler içindir. Lütfen yönetici hesabıyla giriş yapın.
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-column">
                <h3>DİZİT</h3>
                <p>En iyi film ve dizi izleme platformu.</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>© 2025 DİZİT. Tüm hakları saklıdır.</p>
        </div>
    </footer>

    <div class="toast-notification" id="toast-notification"></div>

    <script>
        let isLoggedIn = !!localStorage.getItem('token');
        let currentUser = localStorage.getItem('username') || null;
        let isAdmin = false;
        let originalMovieId = null;

        async function checkAdminStatus() {
            try {
                const token = localStorage.getItem('token');
                if (!token) throw new Error('Token bulunamadı');
                const res = await fetch('/api/check-admin', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                isAdmin = res.ok && data.isAdmin;
                updateAdminUI();
                if (isAdmin) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const movieId = urlParams.get('id');
                    if (movieId) {
                        document.getElementById('movie-id').value = movieId;
                        fetchMovieData();
                    }
                }
            } catch (error) {
                console.error('Admin kontrol hatası:', error);
                updateAdminUI();
            }
        }

        function updateAdminUI() {
            const adminContent = document.getElementById('admin-content');
            const adminMessage = document.getElementById('admin-only-message');
            if (isLoggedIn && isAdmin) {
                adminContent.style.display = 'block';
                adminMessage.style.display = 'none';
            } else {
                adminContent.style.display = 'none';
                adminMessage.style.display = 'block';
            }
            updateAuthUI();
        }

        function updateAuthUI() {
            const authButtons = document.getElementById('auth-buttons');
            const userInfo = document.getElementById('user-info');
            const usernameDisplay = document.getElementById('username-display');
            if (isLoggedIn && currentUser) {
                authButtons.style.display = 'none';
                userInfo.style.display = 'flex';
                usernameDisplay.textContent = currentUser;
            } else {
                authButtons.style.display = 'flex';
                userInfo.style.display = 'none';
            }
        }

        function openAuthModal(type = 'login') {
            const modal = document.getElementById('auth-modal');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            modal.classList.add('active');
            if (type === 'login') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                loginTab.classList.add('active');
                signupTab.classList.remove('active');
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                loginTab.classList.remove('active');
                signupTab.classList.add('active');
            }
        }

        function closeAuthModal() {
            const modal = document.getElementById('auth-modal');
            modal.classList.remove('active');
            document.getElementById('login-error').textContent = '';
            document.getElementById('signup-error').textContent = '';
            document.getElementById('login-form-submit').reset();
            document.getElementById('signup-form-submit').reset();
        }

        function switchTab(type) {
            openAuthModal(type);
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('username', data.username);
                    isLoggedIn = true;
                    currentUser = data.username;
                    closeAuthModal();
                    checkAdminStatus();
                } else {
                    errorEl.textContent = data.error;
                }
            } catch (error) {
                console.error('Giriş hatası:', error);
                errorEl.textContent = 'Bir hata oluştu';
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            const username = document.getElementById('signup-username').value;
            const password = document.getElementById('signup-password').value;
            const passwordConfirm = document.getElementById('signup-password-confirm').value;
            const errorEl = document.getElementById('signup-error');
            if (password !== passwordConfirm) {
                errorEl.textContent = 'Parolalar eşleşmiyor';
                return;
            }
            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (res.ok) {
                    showToast('Kayıt başarılı! Şimdi giriş yapabilirsiniz.');
                    switchTab('login');
                } else {
                    errorEl.textContent = data.error;
                }
            } catch (error) {
                console.error('Kayıt hatası:', error);
                errorEl.textContent = 'Bir hata oluştu';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            isLoggedIn = false;
            currentUser = null;
            isAdmin = false;
            updateAdminUI();
            window.location.href = '../index.html';
        }

        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        async function fetchMovieData() {
            const movieId = document.getElementById('movie-id').value.trim();
            if (!movieId || !/^[a-zA-Z0-9-$]{1,100}$/.test(movieId)) {
                showToast('Geçerli bir ID girin (1-100 karakter, harf ve sayı)');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`/api/movies/${movieId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    console.log('Çekilen veri:', data);
                    originalMovieId = movieId;
                    populateForm(data);
                    updatePreview();
                    showToast('Veriler başarıyla yüklendi');
                } else {
                    showToast(data.error || 'Film/dizi bulunamadı');
                }
            } catch (error) {
                console.error('Veri çekme hatası:', error);
                showToast('Bir hata oluştu');
            }
        }

        function populateForm(movie) {
            console.log('populateForm çağrıldı, movie:', movie);
            document.getElementById('movie-id').value = movie.id || '';
            document.getElementById('movie-title').value = movie.title || '';
            document.getElementById('movie-title2').value = movie.title2 || '';
            document.getElementById('movie-year').value = movie.year || '';
            document.getElementById('movie-runtime').value = movie.runtime || '';
            document.getElementById('movie-rating').value = movie.rating || '';
            document.getElementById('movie-country').value = movie.country?.join(', ') || '';
            document.getElementById('movie-language').value = movie.language?.join(', ') || '';
            document.getElementById('movie-genres').value = movie.genres?.join(', ') || '';
            document.getElementById('movie-poster').value = movie.poster || '';
            document.getElementById('movie-plot').value = movie.plot || '';
            document.getElementById('movie-type').value = movie.type || 'film';
            document.getElementById('movie-related-series').value = movie.relatedSeries?.join(', ') || '';
            const premiumStatus = movie.premium || movie.isPremium || false;
            document.getElementById('movie-premium').checked = premiumStatus;
            console.log('Premium checkbox durumu:', premiumStatus);

            const videoSourceList = document.getElementById('video-source-list');
            videoSourceList.innerHTML = '';
            if (movie.type === 'film' && movie.videoSrc?.length) {
                movie.videoSrc.forEach(src => addVideoSource(src.type, src.src));
            }

            const seasonList = document.getElementById('season-list');
            seasonList.innerHTML = '';
            if (movie.type === 'dizi' && movie.episodes?.length) {
                const seasons = [...new Set(movie.episodes.map(e => e.seasonNumber))];
                seasons.forEach(seasonNumber => {
                    addSeason(seasonNumber, movie.episodes.filter(e => e.seasonNumber === seasonNumber));
                });
            }

            document.getElementById('episodes-section').style.display = movie.type === 'dizi' ? 'block' : 'none';
            document.getElementById('runtime-section').style.display = movie.type === 'film' ? 'block' : 'none';
            document.getElementById('video-sources-section').style.display = movie.type === 'film' ? 'block' : 'none';

            // Ensure video-type-custom visibility for all video sources
            document.querySelectorAll('.video-source-entry').forEach(entry => {
                const select = entry.querySelector('.video-type-select');
                const customInput = entry.querySelector('.video-type-custom');
                customInput.style.display = select.value === 'Diğer' ? 'block' : 'none';
            });
        }

        function validateForm() {
            let isValid = true;
            const isFilm = document.getElementById('movie-type').value === 'film';
            const fields = [
                { id: 'movie-id', errorId: 'movie-id-error', validate: val => /^[a-zA-Z0-9-]+$/.test(val), message: 'ID sadece harf, sayı ve tire içermeli' },
                { id: 'movie-title', errorId: 'movie-title-error', validate: val => val.trim().length > 0, message: 'Başlık zorunlu' },
                { id: 'movie-year', errorId: 'movie-year-error', validate: val => !val || (val >= 1900 && val <= 2100), message: 'Geçerli bir yıl girin' },
                { id: 'movie-runtime', errorId: 'movie-runtime-error', validate: val => !isFilm || !val || /^\d+\s*dk$|^\d+\s*s\s*\d+\s*dk$/.test(val), message: 'Örn: 2 s 10 dk veya 40 dk' },
                { id: 'movie-rating', errorId: 'movie-rating-error', validate: val => !val || (val >= 0 && val <= 10), message: '0-10 arasında bir puan girin' },
                { id: 'movie-poster', errorId: 'movie-poster-error', validate: val => !val || /^https?:\/\/.+\.(jpg|png|jpeg)$/.test(val), message: 'Geçerli bir URL girin (jpg/png)' },
                { id: 'movie-related-series', errorId: 'movie-related-series-error', validate: val => !val || val.split(',').every(id => id.trim() === '' || /^[a-zAZ0-9-$]{1,100}$/.test(id.trim())), message: 'Geçerli ID’ler girin (1-100 karakter, virgülle ayırın)' }
            ];

            fields.forEach(field => {
                const input = document.getElementById(field.id);
                const errorEl = document.getElementById(field.errorId);
                const value = input.value.trim();
                if (!field.validate(value)) {
                    input.parentElement.classList.add('invalid');
                    errorEl.textContent = field.message;
                    isValid = false;
                } else {
                    input.parentElement.classList.remove('invalid');
                    errorEl.textContent = '';
                }
            });

            if (isFilm) {
                const videoSources = document.querySelectorAll('#video-source-list .video-source-entry');
                videoSources.forEach((entry, index) => {
                    const typeSelect = entry.querySelector('.video-type-select').value;
                    const typeCustom = entry.querySelector('.video-type-custom').value.trim();
                    const src = entry.querySelector('.video-src').value.trim();
                    const errorEl = entry.querySelector('.video-error');
                    const type = typeCustom || typeSelect;
                    if (!type || !src || !/^https?:\/\/.+/.test(src)) {
                        entry.classList.add('invalid');
                        errorEl.textContent = 'Geçerli bir tür ve URL girin';
                        isValid = false;
                    } else {
                        entry.classList.remove('invalid');
                        errorEl.textContent = '';
                    }
                });
            }

            if (document.getElementById('movie-type').value === 'dizi') {
                const seasons = document.querySelectorAll('.season-container');
                if (seasons.length === 0) {
                    showToast('En az bir sezon eklemelisiniz');
                    isValid = false;
                }
                seasons.forEach((season, seasonIndex) => {
                    const seasonNumber = parseInt(season.querySelector('.season-number').value);
                    const episodes = season.querySelectorAll('.episode-entry');
                    const errorEl = season.querySelector('.season-error');
                    if (!seasonNumber || seasonNumber < 1) {
                        season.classList.add('invalid');
                        errorEl.textContent = 'Geçerli bir sezon numarası girin';
                        isValid = false;
                    } else {
                        season.classList.remove('invalid');
                        errorEl.textContent = '';
                    }
                    if (episodes.length === 0) {
                        showToast(`Sezon ${seasonNumber} için en az bir bölüm eklemelisiniz`);
                        isValid = false;
                    }
                    episodes.forEach((entry, episodeIndex) => {
                        const episodeNumber = parseInt(entry.querySelector('.episode-number').value);
                        const videoSources = entry.querySelectorAll('.video-source-entry');
                        const errorEl = entry.querySelector('.episode-error');
                        if (!episodeNumber || episodeNumber < 1) {
                            entry.classList.add('invalid');
                            errorEl.textContent = 'Geçerli bir bölüm numarası girin';
                            isValid = false;
                        } else {
                            entry.classList.remove('invalid');
                            errorEl.textContent = '';
                        }
                        videoSources.forEach((srcEntry, srcIndex) => {
                            const typeSelect = srcEntry.querySelector('.video-type-select').value;
                            const typeCustom = srcEntry.querySelector('.video-type-custom').value.trim();
                            const src = srcEntry.querySelector('.video-src').value.trim();
                            const srcErrorEl = srcEntry.querySelector('.video-error');
                            const type = typeCustom || typeSelect;
                            if (!type || !src || !/^https?:\/\/.+/.test(src)) {
                                srcEntry.classList.add('invalid');
                                srcErrorEl.textContent = 'Geçerli bir tür ve URL girin';
                                isValid = false;
                            } else {
                                srcEntry.classList.remove('invalid');
                                srcErrorEl.textContent = '';
                            }
                        });
                    });
                });
            }

            return isValid;
        }

        function updatePreview() {
            const title = document.getElementById('movie-title').value;
            const poster = document.getElementById('movie-poster').value;
            const year = document.getElementById('movie-year').value;
            const genres = document.getElementById('movie-genres').value;
            const plot = document.getElementById('movie-plot').value;
            const isPremium = document.getElementById('movie-premium').checked;

            const previewSection = document.getElementById('preview-section');
            const previewPoster = document.getElementById('preview-poster');
            const previewTitle = document.getElementById('preview-title');
            const previewMeta = document.getElementById('preview-meta');
            const previewPlot = document.getElementById('preview-plot');

            if (title || poster || year || genres || plot) {
                previewSection.style.display = 'block';
                previewPoster.src = poster || 'https://via.placeholder.com/200x300';
                previewTitle.textContent = title || 'Başlık Belirtilmedi';
                previewMeta.textContent = `${year || 'Yıl Belirtilmedi'} | ${genres || 'Tür Belirtilmedi'} | ${isPremium ? 'Premium' : 'Standart'}`;
                previewPlot.textContent = plot || 'Konu özeti girilmedi.';
            } else {
                previewSection.style.display = 'none';
            }
        }

        async function handleEditMovie(event) {
            event.preventDefault();
            console.log('handleEditMovie çağrıldı');
            if (!isLoggedIn || !isAdmin) {
                showToast('Yönetici girişi yapmalısınız');
                openAuthModal('login');
                return;
            }

            if (!validateForm()) {
                showToast('Lütfen formu doğru doldurun');
                return;
            }

            const movieData = {
                id: document.getElementById('movie-id').value.trim(),
                title: document.getElementById('movie-title').value.trim(),
                title2: document.getElementById('movie-title2').value.trim() || null,
                year: parseInt(document.getElementById('movie-year').value) || null,
                runtime: document.getElementById('movie-runtime').value.trim() || null,
                rating: parseFloat(document.getElementById('movie-rating').value) || null,
                country: document.getElementById('movie-country').value.split(',').map(s => s.trim()).filter(s => s) || [],
                language: document.getElementById('movie-language').value.split(',').map(s => s.trim()).filter(s => s) || [],
                genres: document.getElementById('movie-genres').value.split(',').map(s => s.trim()).filter(s => s) || [],
                plot: document.getElementById('movie-plot').value.trim() || null,
                poster: document.getElementById('movie-poster').value.trim() || null,
                type: document.getElementById('movie-type').value,
                premium: document.getElementById('movie-premium').checked,
                videoSrc: [],
                episodes: [],
                season: null,
                relatedSeries: document.getElementById('movie-related-series').value.split(',').map(s => s.trim()).filter(s => s) || []
            };

            if (movieData.type === 'film') {
                const videoSources = document.querySelectorAll('#video-source-list .video-source-entry');
                movieData.videoSrc = Array.from(videoSources).map(entry => {
                    const typeSelect = entry.querySelector('.video-type-select').value;
                    const typeCustom = entry.querySelector('.video-type-custom').value.trim();
                    const src = entry.querySelector('.video-src').value.trim();
                    return { type: typeCustom || typeSelect, src };
                }).filter(v => v.src);
                movieData.episodes = [];
                movieData.season = null;
            } else if (movieData.type === 'dizi') {
                const seasons = document.querySelectorAll('.season-container');
                movieData.episodes = Array.from(seasons).flatMap(season => {
                    const seasonNumber = parseInt(season.querySelector('.season-number').value) || 1;
                    const episodes = season.querySelectorAll('.episode-entry');
                    return Array.from(episodes).map(entry => {
                        const episodeNumber = parseInt(entry.querySelector('.episode-number').value) || 1;
                        const episodeTitle = entry.querySelector('.episode-title')?.value.trim() || `Sezon ${seasonNumber} Bölüm ${episodeNumber}`;
                        const addedDate = entry.querySelector('.episode-added-date')?.value || undefined;
                        const videoSources = entry.querySelectorAll('.video-source-entry');
                        const videoSrc = Array.from(videoSources).map(srcEntry => {
                            const typeSelect = srcEntry.querySelector('.video-type-select').value;
                            const typeCustom = srcEntry.querySelector('.video-type-custom').value.trim();
                            const src = srcEntry.querySelector('.video-src').value.trim();
                            return { type: typeCustom || typeSelect, src };
                        }).filter(v => v.src);
                        return {
                            seasonNumber,
                            episodeNumber,
                            title: episodeTitle,
                            videoSrc,
                            ...(addedDate && { addedDate })
                        };
                    });
                });
                movieData.season = movieData.episodes.length ? Math.max(...movieData.episodes.map(e => e.seasonNumber)) : null;
                movieData.runtime = null;
                movieData.videoSrc = [];
            } else {
                console.error('Geçersiz tür:', movieData.type);
                showToast('Geçersiz içerik türü seçildi');
                return;
            }

            console.log('Gönderilen movieData:', JSON.stringify(movieData, null, 2));

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`/api/movies/${originalMovieId || movieData.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(movieData)
                });
                const data = await res.json();
                console.log('Backend yanıtı:', data);
                if (res.ok) {
                    originalMovieId = movieData.id;
                    showToast('Değişiklikler başarıyla kaydedildi! Yeni bölümler ana sayfada görünecek.');
                    fetchMovieData();
                } else {
                    showToast(data.error || 'Değişiklikler kaydedilemedi');
                    console.error('Hata detayları:', data);
                }
            } catch (error) {
                console.error('Güncelleme hatası:', error);
                showToast('Bir hata oluştu: ' + error.message);
            }
        }

        async function deleteMovie() {
            if (!isLoggedIn || !isAdmin) {
                showToast('Yönetici girişi yapmalısınız');
                openAuthModal('login');
                return;
            }

            const movieId = document.getElementById('movie-id').value.trim();
            if (!movieId) {
                showToast('Silmek için bir ID girin');
                return;
            }

            if (!confirm('Bu film veya diziyi silmek istediğinizden emin misiniz?')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`/api/movies/${movieId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    showToast('Film/dizi başarıyla silindi!');
                    document.getElementById('movie-form').reset();
                    document.getElementById('video-source-list').innerHTML = '';
                    document.getElementById('season-list').innerHTML = '';
                    document.getElementById('preview-section').style.display = 'none';
                    originalMovieId = null;
                } else {
                    showToast(data.error || 'Silme işlemi başarısız');
                }
            } catch (error) {
                console.error('Silme hatası:', error);
                showToast('Bir hata oluştu');
            }
        }

      function addVideoSource(type, src = '', targetList = document.getElementById('video-source-list')) {
    // Eğer 'type' boşsa veya zorla otomatik belirlemek istiyorsan:
    if (!type || type === 'Dublaj') {
        const languageInput = document.getElementById('movie-language');
        const rawValue = languageInput?.value?.toLowerCase() || '';
        const languages = rawValue.split(',').map(lang => lang.trim());

        const hasTurkceDublaj = languages.some(l => l.includes('türkçe') && l.includes('dublaj'));
        const hasTurkceAltyazi = languages.some(l => l.includes('türkçe') && l.includes('altyazı'));
        const hasDublaj = languages.some(l => l.includes('dublaj'));
        const hasAltyazi = languages.some(l => l.includes('altyazı'));
        const hasYerli = languages.some(l => l.includes('yerli'));

        if (hasTurkceDublaj && hasTurkceAltyazi) {
            type = 'Türkçe Dublaj & Altyazı';
        } else if (hasTurkceDublaj) {
            type = 'Dublaj';
        } else if (hasTurkceAltyazi) {
            type = 'Altyazı';
        } else if (hasYerli) {
            type = 'Yerli';
        } else if (hasDublaj && hasAltyazi) {
            type = 'Türkçe Dublaj & Altyazı';
        } else if (hasDublaj) {
            type = 'Dublaj';
        } else if (hasAltyazi) {
            type = 'Altyazı';
        } else {
            type = 'Diğer';
        }
    }

    const isCustom = !['Dublaj', 'Altyazı', 'Türkçe Dublaj & Altyazı', 'Yerli'].includes(type);

    const videoDiv = document.createElement('div');
    videoDiv.className = 'video-source-entry';
    videoDiv.innerHTML = `
        <select class="video-type-select">
            <option value="Dublaj" ${type === 'Dublaj' ? 'selected' : ''}>Dublaj</option>
            <option value="Altyazı" ${type === 'Altyazı' ? 'selected' : ''}>Altyazı</option>
            <option value="Türkçe Dublaj & Altyazı" ${type === 'Türkçe Dublaj & Altyazı' ? 'selected' : ''}>Türkçe Dublaj & Altyazı</option>
            <option value="Yerli" ${type === 'Yerli' ? 'selected' : ''}>Yerli</option>
            <option value="Diğer" ${isCustom ? 'selected' : ''}>Diğer</option>
        </select>
        <input type="text" class="video-type-custom" placeholder="Özel tür girin" value="${isCustom ? type : ''}" style="display: ${isCustom ? 'block' : 'none'};">
        <input type="url" class="video-src" placeholder="Video URL" value="${src}">
        <button type="button" class="remove-video">Kaldır</button>
        <span class="validation-message video-error"></span>
    `;

    targetList.appendChild(videoDiv);

    const select = videoDiv.querySelector('.video-type-select');
    const customInput = videoDiv.querySelector('.video-type-custom');
    select.addEventListener('change', function () {
        customInput.style.display = this.value === 'Diğer' ? 'block' : 'none';
    });

    videoDiv.querySelector('.remove-video').addEventListener('click', () => videoDiv.remove());
}



function addSeason(seasonNumber = document.querySelectorAll('.season-container').length + 1, episodes = []) {
    const seasonList = document.getElementById('season-list');
    const seasonDiv = document.createElement('div');
    seasonDiv.className = 'season-container'; // ✅ Mevcut sezonlar kapalı olacak, yeni sezona aktif olacak

    seasonDiv.innerHTML = `
        <h3>Sezon ${seasonNumber}</h3>
        <div class="season-content">
            <input type="number" class="season-number" value="${seasonNumber}" min="1" required>
            <span class="validation-message season-error"></span>
            <div class="episode-list"></div>
            <button type="button" class="add-episode-btn">Bölüm Ekle</button>
            <button type="button" class="remove-season">Sezonu Kaldır</button>
        </div>
    `;
    seasonList.appendChild(seasonDiv);

    const episodeList = seasonDiv.querySelector('.episode-list');

    // Eğer dışarıdan gelen eski bölüm verisi varsa onları ekle
    if (episodes.length > 0) {
        episodes.forEach(episode => {
            const episodeDiv = document.createElement('div');
            episodeDiv.className = 'episode-entry';
            episodeDiv.innerHTML = `
                <input type="number" class="episode-number" value="${episode.episodeNumber}" min="1" required>
                <input type="text" class="episode-title" value="${episode.title || ''}" placeholder="Bölüm başlığı (opsiyonel)">
                <input type="hidden" class="episode-added-date" value="${episode.addedDate || ''}">
                <div class="video-source-list" style="grid-column: span 2;"></div>
                <button type="button" class="add-episode-video-btn">Video Kaynağı Ekle</button>
                <button type="button" class="remove-episode">Bölüm Kaldır</button>
                <span class="validation-message episode-error"></span>
            `;
            episodeList.appendChild(episodeDiv);

            const videoList = episodeDiv.querySelector('.video-source-list');
            episode.videoSrc.forEach(src => {
                addVideoSource(src.type, src.src, videoList);
            });

            episodeDiv.querySelector('.remove-episode').addEventListener('click', () => episodeDiv.remove());
            episodeDiv.querySelector('.add-episode-video-btn').addEventListener('click', () => {
                addVideoSource('', '', videoList);
            });
        });
    } else {
        // Yeni eklenen sezon için 8 bölüm otomatik ekle
        for (let i = 1; i <= 8; i++) {
            const episodeDiv = document.createElement('div');
            episodeDiv.className = 'episode-entry';
            episodeDiv.innerHTML = `
                <input type="number" class="episode-number" value="${i}" min="1" required>
                <input type="text" class="episode-title" placeholder="Bölüm başlığı (opsiyonel)">
                <div class="video-source-list" style="grid-column: span 2;"></div>
                <button type="button" class="add-episode-video-btn">Video Kaynağı Ekle</button>
                <button type="button" class="remove-episode">Bölüm Kaldır</button>
                <span class="validation-message episode-error"></span>
            `;
            episodeList.appendChild(episodeDiv);

            const videoList = episodeDiv.querySelector('.video-source-list');
            addVideoSource('', '', videoList);

            episodeDiv.querySelector('.remove-episode').addEventListener('click', () => episodeDiv.remove());
            episodeDiv.querySelector('.add-episode-video-btn').addEventListener('click', () => {
                addVideoSource('', '', videoList);
            });
        }
    }

    // Sezon başlığına tıklanınca sadece bu sezon aç/kapa olacak şekilde
    seasonDiv.querySelector('h3').addEventListener('click', () => {
        seasonDiv.classList.toggle('active');
    });

    // Sezonu silmek için
    seasonDiv.querySelector('.remove-season').addEventListener('click', () => {
        seasonDiv.remove();
        updateSeasonNumbers();
    });

    // Yeni bölüm ekleme butonuna tıklayınca
    seasonDiv.querySelector('.add-episode-btn').addEventListener('click', () => {
        const episodeCount = episodeList.querySelectorAll('.episode-entry').length + 1;
        const episodeDiv = document.createElement('div');
        episodeDiv.className = 'episode-entry';
        episodeDiv.innerHTML = `
            <input type="number" class="episode-number" value="${episodeCount}" min="1" required>
            <input type="text" class="episode-title" placeholder="Bölüm başlığı (opsiyonel)">
            <div class="video-source-list" style="grid-column: span 2;"></div>
            <button type="button" class="add-episode-video-btn">Video Kaynağı Ekle</button>
            <button type="button" class="remove-episode">Bölüm Kaldır</button>
            <span class="validation-message episode-error"></span>
        `;
        episodeList.appendChild(episodeDiv);

        const videoList = episodeDiv.querySelector('.video-source-list');
        addVideoSource('', '', videoList);

        episodeDiv.querySelector('.remove-episode').addEventListener('click', () => episodeDiv.remove());
        episodeDiv.querySelector('.add-episode-video-btn').addEventListener('click', () => {
            addVideoSource('', '', videoList);
        });
    });
}




        function updateSeasonNumbers() {
            const seasons = document.querySelectorAll('.season-container');
            seasons.forEach((season, index) => {
                const seasonNumber = index + 1;
                season.querySelector('h3').textContent = `Sezon ${seasonNumber}`;
                season.querySelector('.season-number').value = seasonNumber;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Sayfa yüklendi, admin durumu kontrol ediliyor');
            
            const premiumCheckbox = document.getElementById('movie-premium');
            if (premiumCheckbox) {
                console.log('movie-premium bulundu');
                premiumCheckbox.addEventListener('change', function() {
                    console.log('Checkbox durumu değişti:', this.checked);
                    showToast(this.checked ? 'İçerik premium yapıldı' : 'İçerik standart yapıldı');
                    validateForm();
                    updatePreview();
                });
            } else {
                console.error('HATA: movie-premium ID bulunamadı');
            }

            checkAdminStatus();

            const burgerMenu = document.getElementById('burger-menu');
            const navContainer = document.getElementById('nav-container');
            burgerMenu.addEventListener('click', () => {
                navContainer.classList.toggle('active');
            });

            const inputs = document.querySelectorAll('#movie-form input, #movie-form textarea, #movie-form select');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    validateForm();
                    updatePreview();
                });
            });

            document.getElementById('movie-type').addEventListener('change', function() {
                const episodesSection = document.getElementById('episodes-section');
                const runtimeSection = document.getElementById('runtime-section');
                const videoSourcesSection = document.getElementById('video-sources-section');
                episodesSection.style.display = this.value === 'dizi' ? 'block' : 'none';
                runtimeSection.style.display = this.value === 'film' ? 'block' : 'none';
                videoSourcesSection.style.display = this.value === 'film' ? 'block' : 'none';
                if (this.value === 'dizi') {
                    document.getElementById('movie-runtime').value = '';
                    document.getElementById('video-source-list').innerHTML = '';
                    if (!document.querySelector('.season-container')) {
                        addSeason();
                    }
                } else {
                    document.getElementById('season-list').innerHTML = '';
                }
                updatePreview();
            });

            document.getElementById('add-video-btn').addEventListener('click', () => {
                addVideoSource();
            });

            document.getElementById('add-season-btn').addEventListener('click', () => {
                addSeason();
            });
        });
    </script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'937a05b76ee5bf68',t:'MTc0NTg3OTYxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'937a1b341b377221',t:'MTc0NTg4MDQ5Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>