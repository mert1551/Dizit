<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Film İzle - DİZİT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/style.css?v=1">
    <link rel="stylesheet" href="/film.css?v=1">
    <style>
        /* Mevcut Stiller */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121212;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }
        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .loading-logo {
            font-size: 48px;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
            margin-bottom: 30px;
            animation: glow 2s infinite ease-in-out;
        }
        .popcorn-loader {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100px;
            height: 60px;
        }
        .popcorn {
            position: absolute;
            width: 15px;
            height: 15px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            animation: pop 1.2s infinite ease-in-out;
        }
        .popcorn:nth-child(1) { left: 20px; animation-delay: 0s; }
        .popcorn:nth-child(2) { left: 40px; animation-delay: 0.2s; }
        .popcorn:nth-child(3) { left: 60px; animation-delay: 0.4s; }
        @keyframes pop {
            0%, 100% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-30px) scale(1.2); opacity: 0.7; }
        }
        @keyframes glow {
            0% { text-shadow: 0 0 10px rgba(255, 204, 0, 0.5); }
            50% { text-shadow: 0 0 20px rgba(255, 204, 0, 0.8); }
            100% { text-shadow: 0 0 10px rgba(255, 204, 0, 0.5); }
        }
   
.replies {
    display: block;
    max-width: 100%;
    overflow-x: auto; /* Yatay taşma için kaydırma çubuğu */
}
.comment.reply {
    display: block;
    margin-left: 35px;
    background-color: #2c2c2c;
    padding: 12px;
    font-size: 0.95em;
    border-left: 2px dashed #444444;
}

.comment.reply .reply {
    margin-left: 50px; /* Daha derin yanıtlar için ek girinti */
}
.replies {
    overflow: visible;
    max-width: 100%;
}
.replies-toggle {
    background: none;
    border: none;
    color: #a5a5a5;
    cursor: pointer;
    font-size: 13px;
    margin-top: 5px;
    display: flex;
    align-items: center;
}
.replies-toggle:hover {
    color: #ffffff;
}
.replies-toggle i {
    margin-right: 5px;
}

/* Card-Like Comments Section Styles */
.comments-section {
    margin-top: 25px;
    padding: 20px;
    background-color: #1f1f1f;
    border-radius: 8px;
    color: #d5d5d5;
    border: 1px solid #2a2a2a;
}

.comments-section h2 {
    color: #ffffff;
    font-size: 24px;
    margin-bottom: 20px;
    font-weight: 500;
    border-bottom: 1px solid #333333;
    padding-bottom: 10px;
}

#comment-form-container {
    margin-bottom: 20px;
}

#comment-form textarea {
    width: 100%;
    min-height: 110px;
    padding: 12px;
    background-color: #262626;
    color: #d5d5d5;
    border: 1px solid #333333;
    border-radius: 6px;
    resize: vertical;
    font-family: inherit;
    font-size: 14px;
}

#comment-form button {
    padding: 10px 20px;
    background-color: var(--accent-color);
    color:var(--text-color);
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    margin-top: 10px;
    display: block;
    transition: background-color 0.2s ease;
}

#comment-form button:hover {
    background-color: #4a4a4a;
}

#login-prompt {
    color: #a5a5a5;
    font-size: 14px;
    text-align: center;
    margin-bottom: 5px;
}

#login-prompt a {
    color: var(--accent-color);
    text-decoration: none;
}

#login-prompt a:hover {
    text-decoration: underline;
    color: #cfaa17;
}

.comment {
    background-color: #272727;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 6px;
    border: 1px solid #2f2f2f;
}

.comment.reply {
    margin-left: 35px;
    background-color: #2c2c2c;
    padding: 12px;
    font-size: 0.95em;
    border-left: 2px dashed #444444;
}

.comment-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.comment-header img {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #444444;
}

.comment.reply .comment-header img {
    width: 30px;
    height: 30px;
}

.username-link {
    color:var(--accent-color);
    text-decoration: none;
    font-weight: 500;
    font-size: 15px;
}

.username-link:hover {
    color: #b29520;
}

.comment-time {
    color: #a5a5a5;
    font-size: 12px;
    margin-left: auto;
}

.comment-content {
    color: #d0d0d0;
    margin-bottom: 10px;
    line-height: 1.5;
    font-size: 14px;
}

.comment.reply .comment-content {
    font-size: 13px;
}

.comment-actions {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-bottom: 5px;
}

.comment-actions button {
    background: none;
    border: none;
    color: #a5a5a5;
    cursor: pointer;
    font-size: 13px;
    display: flex;
    align-items: center;
    transition: color 0.2s ease;
}

.comment-actions button:hover {
    color: #ffffff;
}

.comment-actions button i {
    margin-right: 5px;
}

.comment-actions button.active {
    color: #ffffff;
}

.comment-actions button.disabled {
    color: #555555;
    cursor: not-allowed;
}

.comment-actions span {
    color: #a5a5a5;
    margin-left: 5px;
    font-size: 12px;
}

.reply-form-container {
    display: none;
    margin-top: 10px;
}

.reply-form-container.active {
    display: block;
}

.reply-form-container textarea {
    width: 100%;
    min-height: 80px;
    padding: 10px;
    background-color: #2c2c2c;
    color: #d5d5d5;
    border: 1px solid #333333;
    border-radius: 6px;
    font-family: inherit;
    font-size: 13px;
    resize: vertical;
}

.reply-form-container button {
    padding: 8px 16px;
    background-color: #3a3a3a;
    color: #ffffff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    margin-top: 8px;
    transition: background-color 0.2s ease;
}

.reply-form-container button:hover {
    background-color: #4a4a4a;
}


  .premium-icon {
            position: absolute;
            top: 3px;
            right: 3px;
            background: #ffcc00;
            color: #121212;
            padding: 5px;
            border-radius: 50%;
            font-size: 14px;
            z-index: 10;
        }
        .premium-comment-icon{
            color: #ffcc00;
            font-size: 14px;
            margin-right: 3px;

        }

/* Responsive adjustments */
@media (max-width: 768px) {
    .comment {
        padding: 12px;
    }
    .comment.reply {
        margin-left: 20px;
        padding: 10px;
    }
    .comment-header img {
        width: 32px;
        height: 32px;
    }
    .comment-content {
        font-size: 13px;
    }
    .comment-actions {
        gap: 12px;
    }
    .comment-actions button {
        font-size: 12px;
    }
}

@media (max-width: 480px) {
    .comments-section h2 {
        font-size: 20px;
    }
    .comment.reply {
        margin-left: 15px;
    }
    .comment-actions {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    .comment-header img {
        width: 28px;
        height: 28px;
    }
    .username-link {
        font-size: 14px;
    }
    .comment-time {
        font-size: 11px;
    }
}







    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="curtain-container">
            <div class="curtain-left"></div>
            <div class="curtain-right"></div>
        </div>
        <div class="loading-logo">DİZİT</div>
        <div class="popcorn-loader">
            <div class="popcorn"></div>
            <div class="popcorn"></div>
            <div class="popcorn"></div>
        </div>
    </div>

    <header id="header">
        <a href="/" class="logo">DİZİT</a>
        <div class="header-right">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Film veya dizi ara...">
                <button id="search-btn"><i class="fas fa-search"></i></button>
            </div>
            <div class="burger-menu" id="burger-menu">
                <i class="fas fa-bars"></i>
            </div>
        </div>
        <div class="nav-container" id="nav-container">
            <ul class="nav-links">
                <li><a href="/" class="home-link">Anasayfa</a></li>
                <li><a href="/filmler.html?type=film">Filmler</a></li>
                <li><a href="/diziler.html?type=dizi">Diziler</a></li>
                <li><a href="/arama/film-dizi-arama.html">Detaylı Arama</a></li>
                <li><a href="/request-complaint.html">İstek ve Şikayet</a></li>
            </ul>
        </div>
        <div class="profile-wrapper">
            <div class="profile-card" onclick="toggleProfileMenu()">
                <img src="/resim/avatar/user.png" alt="Profile Avatar" class="profile-avatar">
                <span class="profile-username"></span>
                <i class="fas fa-chevron-down profile-arrow"></i>
            </div>
            <div class="profile-dropdown" id="profile-dropdown">
                <ul class="profile-menu">
                    <li><a href="/hesabim.html"><i class="fas fa-user"></i> Profilim</a></li>
                    <li><a href="/ayarlar.html"><i class="fas fa-cog"></i> Ayarlar</a></li>
                    <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Çıkış Yap</a></li>
                </ul>
            </div>
        </div>
    </header>

    <div class="auth-modal" id="auth-modal">
        <div class="auth-modal-content">
            <button class="close-modal" onclick="closeAuthModal()"><i class="fas fa-times"></i></button>
            <div class="auth-tabs">
                <button class="tab-btn active" id="login-tab" onclick="switchTab('login')">Giriş Yap</button>
                <button class="tab-btn" id="signup-tab" onclick="switchTab('signup')">Üye Ol</button>
                <button class="tab-btn" id="forgot-tab" onclick="switchTab('forgot')">Şifremi Unuttum</button>
            </div>
            <div class="auth-form" id="login-form">
                <h2>Giriş Yap</h2>
                <form id="login-form-submit" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="login-username">Kullanıcı Adı</label>
                        <input type="text" id="login-username" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Parola</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <p class="error-message" id="login-error"></p>
                    <button type="submit" class="auth-submit">Giriş Yap</button>
                    <p class="forgot-link" onclick="switchTab('forgot')">Şifrenizi mi unuttunuz?</p>
                </form>
            </div>
            <div class="auth-form" id="signup-form" style="display: none;">
                <h2>Üye Ol</h2>
                <form id="signup-form-submit" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label for="signup-username">Kullanıcı Adı</label>
                        <input type="text" id="signup-username" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-email">E-posta</label>
                        <input type="email" id="signup-email" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Parola</label>
                        <input type="password" id="signup-password" required oninput="validatePassword()">
                        <p class="password-hint" id="password-hint">Parola en az 8 karakter, 1 büyük harf, 1 küçük harf ve 1 rakam içermelidir.</p>
                    </div>
                    <div class="form-group">
                        <label for="signup-password-confirm">Parola Tekrar</label>
                        <input type="password" id="signup-password-confirm" required>
                    </div>
                    <p class="error-message" id="signup-error"></p>
                    <button type="submit" class="auth-submit">Üye Ol</button>
                </form>
            </div>
            <div class="auth-form" id="forgot-form" style="display: none;">
                <h2>Şifremi Unuttum</h2>
                <form id="forgot-form-submit" onsubmit="handleForgotPassword(event)">
                    <div class="form-group">
                        <label for="forgot-email">E-posta</label>
                        <input type="email" id="forgot-email" required>
                    </div>
                    <p class="error-message" id="forgot-error"></p>
                    <p class="success-message" id="forgot-success"></p>
                    <button type="submit" class="auth-submit">Şifre Sıfırlama Bağlantısı Gönder</button>
                </form>
            </div>
        </div>
    </div>

    <div class="search-overlay" id="search-overlay">
        <div class="search-overlay-header">
            <input type="text" id="search-overlay-input" placeholder="Film veya dizi ara...">
            <button id="close-overlay" class="close-overlay-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="search-results" id="search-results"></div>
    </div>

    <main>
        <div class="film-container" id="film-container"></div>
        <section class="player-container" id="player-container"></section>
        <section class="related-series" id="related-series">
            <h2 class="related-series-title">Serinin Diğer Filmleri</h2>
            <div class="related-series-list" id="related-series-list">
                <p>Yükleniyor...</p>
            </div>
        </section>
        <section class="similar-movies" id="similar-movies"></section>
        <!-- Güncellenmiş Yorum Bölümü -->
        <section class="comments-section" id="comments-section">
            <h2>Yorumlar</h2>
            <div id="comment-form-container" style="display: none;">
                <form id="comment-form">
                    <textarea id="comment-content" placeholder="Yorumunuzu yazın..." required></textarea>
                    <button type="submit">Yorum Gönder</button>
                </form>
            </div>
            <p id="login-prompt" style="display: none;">Yorum yazmak için <a href="#" onclick="openAuthModal('login')">giriş yapın</a>.</p>
            <div id="comments-list">Yorumlar yükleniyor...</div>

        </section>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-column">
                <h2>DİZİT</h2>
                <p>En iyi film ve dizi izleme platformu.</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>© 2025 DİZİT. Tüm hakları saklıdır.</p>
        </div>
    </footer>

    <script>
        let isLoggedIn = !!localStorage.getItem('token');
        let currentUser = localStorage.getItem('username') || null;
        let movieCache = null;
        let apiUrl = '';
        let isPremiumUser = false;

        async function fetchApiUrl() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                apiUrl = data.apiUrl || 'http://localhost:3000';
            } catch (error) {
                console.error('API URL alınamadı:', error);
                apiUrl = 'http://localhost:3000';
            }
        }

        async function checkPremiumStatus() {
            if (!isLoggedIn) return false;
            try {
                const res = await fetch(`${apiUrl}/api/check-premium`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    isPremiumUser = data.isPremium;
                    return isPremiumUser;
                } else {
                    isPremiumUser = false;
                    return false;
                }
            } catch (error) {
                console.error('Premium status check error:', error);
                isPremiumUser = false;
                return false;
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function updateProfileAvatar() {
            const profileAvatar = document.querySelector('.profile-avatar');
            const profileUsername = document.querySelector('.profile-username');
            if (!isLoggedIn) {
                profileAvatar.src = '/resim/avatar/user.png';
                profileUsername.textContent = 'Giriş Yap';
                return;
            }
            try {
                const response = await fetch(`${apiUrl}/api/user-profile?t=${Date.now()}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        showToast('Oturumunuzun süresi doldu. Lütfen yeniden giriş yapın.', 'error');
                        localStorage.removeItem('token');
                        localStorage.removeItem('username');
                        isLoggedIn = false;
                        currentUser = null;
                        openAuthModal('login');
                    }
                    throw new Error('Kullanıcı verileri alınamadı');
                }
                const user = await response.json();
                profileAvatar.src = user.avatar || '/resim/avatar/user.png';
                profileAvatar.onerror = () => {
                    profileAvatar.src = '/resim/avatar/user.png';
                };
                profileUsername.textContent = user.username || 'Kullanıcı';
                localStorage.setItem('username', user.username);
            } catch (error) {
                console.error('Profil verileri yüklenemedi:', error);
                profileAvatar.src = '/resim/avatar/user.png';
                profileUsername.textContent = localStorage.getItem('username') || 'Giriş Yap';
            }
        }

        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                isLoggedIn = false;
                currentUser = null;
                await updateProfileAvatar();
                return false;
            }
            try {
                const res = await fetch(`${apiUrl}/api/verify-token`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    isLoggedIn = true;
                    currentUser = data.username;
                    localStorage.setItem('username', data.username);
                    await updateProfileAvatar();
                    return true;
                } else {
                    localStorage.removeItem('token');
                    localStorage.removeItem('username');
                    isLoggedIn = false;
                    currentUser = null;
                    await updateProfileAvatar();
                    return false;
                }
            } catch (error) {
                console.error('Token doğrulama hatası:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                isLoggedIn = false;
                currentUser = null;
                await updateProfileAvatar();
                return false;
            }
        }

        function openAuthModal(type = 'login') {
            const modal = document.getElementById('auth-modal');
            modal.classList.add('active');
            switchTab(type);
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').classList.remove('active');
            document.getElementById('login-error').textContent = '';
            document.getElementById('signup-error').textContent = '';
            document.getElementById('forgot-error').textContent = '';
            document.getElementById('forgot-success').textContent = '';
            document.getElementById('login-form-submit').reset();
            document.getElementById('signup-form-submit').reset();
            document.getElementById('forgot-form-submit').reset();
            document.getElementById('password-hint').style.color = '#666';
        }

        function toggleProfileMenu() {
            const dropdown = document.getElementById('profile-dropdown');
            if (!isLoggedIn) {
                openAuthModal('login');
            } else {
                dropdown.classList.toggle('active');
            }
        }

        function closeProfileMenu() {
            const dropdown = document.getElementById('profile-dropdown');
            dropdown.classList.remove('active');
        }

        function switchTab(type) {
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            const forgotTab = document.getElementById('forgot-tab');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const forgotForm = document.getElementById('forgot-form');
            const loginError = document.getElementById('login-error');
            const signupError = document.getElementById('signup-error');
            const forgotError = document.getElementById('forgot-error');
            const forgotSuccess = document.getElementById('forgot-success');

            loginTab.classList.toggle('active', type === 'login');
            signupTab.classList.toggle('active', type === 'signup');
            forgotTab.classList.toggle('active', type === 'forgot');
            loginForm.style.display = type === 'login' ? 'block' : 'none';
            signupForm.style.display = type === 'signup' ? 'block' : 'none';
            forgotForm.style.display = type === 'forgot' ? 'block' : 'none';
            loginError.textContent = '';
            signupError.textContent = '';
            forgotError.textContent = '';
            forgotSuccess.textContent = '';
            document.getElementById('login-form-submit').reset();
            document.getElementById('signup-form-submit').reset();
            document.getElementById('forgot-form-submit').reset();
            document.getElementById('password-hint').style.color = '#666';
        }

        function validatePassword() {
            const password = document.getElementById('signup-password').value;
            const hint = document.getElementById('password-hint');
            const strongPasswordRegex = /^(?=.*[a-z])(?!.*[ğüşöçı])(?=.*[A-Z])(?!.*[ĞÜŞÖÇİ])(?=.*\d)[A-Za-z\d]{8,}$/;
            if (!strongPasswordRegex.test(password) && password.length > 0) {
                hint.style.color = '#e74c3c';
            } else {
                hint.style.color = '#666';
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            try {
                const res = await fetch(`${apiUrl}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('userId', data.userId);
                    isLoggedIn = true;
                    currentUser = data.username;
                    errorEl.textContent = '';
                    closeAuthModal();
                    await updateProfileAvatar();
                    window.location.reload();
                } else {
                    errorEl.textContent = data.error || 'Giriş başarısız';
                }
            } catch (error) {
                errorEl.textContent = 'Sunucuyla bağlantı hatası';
            }
        }
      function checkUserSession() {
    const token = localStorage.getItem('token');
    const userId = localStorage.getItem('userId');

    // Eğer token veya userId eksikse, sadece o anahtarı temizle
    if (!token) {
        localStorage.removeItem('token');
    }

    if (!userId) {
        localStorage.removeItem('userId');
    }

    // Kullanıcı giriş yapmamışsa, username bilgisini temizle
    if (!token || !userId) {
        localStorage.removeItem('username');
        isLoggedIn = false;
        currentUser = null;
    } else {
        isLoggedIn = true;
        currentUser = localStorage.getItem('username');
    }
}


        async function handleSignup(event) {
            event.preventDefault();
            const username = document.getElementById('signup-username').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const passwordConfirm = document.getElementById('signup-password-confirm').value;
            const errorEl = document.getElementById('signup-error');
            const strongPasswordRegex = /^(?=.*[a-z])(?!.*[ğüşöçı])(?=.*[A-Z])(?!.*[ĞÜŞÖÇİ])(?=.*\d)[A-Za-z\d]{8,}$/;

            if (!strongPasswordRegex.test(password)) {
                errorEl.textContent = 'Parola en az 8 karakter, 1 büyük harf, 1 küçük harf ve 1 rakam içermelidir.';
                return;
            }
            if (password !== passwordConfirm) {
                errorEl.textContent = 'Parolalar eşleşmiyor';
                return;
            }
            try {
                const res = await fetch(`${apiUrl}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                const data = await res.json();
                if (res.ok) {
                    const loginRes = await fetch(`${apiUrl}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const loginData = await loginRes.json();
                    if (loginRes.ok) {
                        localStorage.setItem('token', loginData.token);
                        localStorage.setItem('username', loginData.username);
                        localStorage.setItem('userId', loginData.userId);
                        isLoggedIn = true;
                        currentUser = loginData.username;
                        closeAuthModal();
                        await updateProfileAvatar();
                        window.location.reload();
                    } else {
                        errorEl.textContent = loginData.error || 'Otomatik giriş başarısız';
                    }
                } else {
                    errorEl.textContent = data.error || 'Kayıt başarısız';
                }
            } catch (error) {
                errorEl.textContent = 'Sunucuyla bağlantı hatası';
            }
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            const email = document.getElementById('forgot-email').value;
            const errorEl = document.getElementById('forgot-error');
            const successEl = document.getElementById('forgot-success');
            try {
                const res = await fetch(`${apiUrl}/api/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                if (res.ok) {
                    successEl.textContent = 'Şifre sıfırlama bağlantısı e-postanıza gönderildi.';
                    errorEl.textContent = '';
                } else {
                    errorEl.textContent = data.error || 'Şifre sıfırlama başarısız';
                    successEl.textContent = '';
                }
            } catch (error) {
                errorEl.textContent = 'Sunucuyla bağlantı hatası';
                successEl.textContent = '';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('userId');
            isLoggedIn = false;
            currentUser = null;
            updateProfileAvatar();
            window.location.href = '/';
        }

        function getMovieIdFromDynamicUrl() {
            const match = window.location.pathname.match(/^\/film\/([^\/]+)/);
            if (match) {
                return match[1];
            }
            return null;
        }

        async function fetchMovieById(id) {
            try {
                const res = await fetch(`${apiUrl}/api/movies/${id}`);
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'İçerik bulunamadı');
                }
                return await res.json();
            } catch (error) {
                console.error('Fetch movie error:', error.message);
                return null;
            }
        }

        function displayErrorPage() {
            const container = document.getElementById('film-container');
            container.innerHTML = `
                <div class="error-container">
                    <i class="fas fa-exclamation-circle error-icon"></i>
                    <h2>Üzgünüz, İçerik Bulunamadı</h2>
                    <p>Aradığınız içerik arşivimizde bulunmamıştır.</p>
                    <a href="/" class="home-button">Ana Sayfaya Dön</a>
                    <p>Veya<br> <a href="/istek-form/request-complaint.html" class="home-button">İstekte Bulunun</a></p>
                </div>
            `;
            document.getElementById('player-container').style.display = 'none';
            document.getElementById('similar-movies').style.display = 'none';
            document.getElementById('comments-section').style.display = 'none';
            document.getElementById('loading-screen').classList.add('hidden');
        }

        function displayMovieDetails(movie) {
            const container = document.getElementById('film-container');
            const hero = document.createElement('div');
            hero.className = 'film-hero';

            const posterWrapper = document.createElement('div');
            posterWrapper.className = 'poster-wrapper';

            const poster = document.createElement('img');
            poster.className = 'film-poster';
            poster.src = movie.poster || 'https://via.placeholder.com/300x450';
            poster.alt = movie.title;

            const premiumIcon = movie.premium ? '<i class="fas fa-crown premium-icon"></i>' : '';
            posterWrapper.innerHTML = premiumIcon;
            posterWrapper.appendChild(poster);

            const info = document.createElement('div');
            info.className = 'film-info';

            const title = document.createElement('h1');
            title.className = 'film-title';
            title.textContent = movie.title || 'Bilinmeyen İçerik';
            if (movie.title2) {
                const title2 = document.createElement('span');
                title2.className = 'film-title2';
                title2.textContent = ` (${movie.title2})`;
                title.appendChild(title2);
            }

            const meta = document.createElement('div');
            meta.className = 'film-meta';
            meta.appendChild(createMetaItem('calendar', movie.year || 'N/A'));
            meta.appendChild(createMetaItem('clock', movie.runtime || 'N/A'));
            meta.appendChild(createMetaItem('star', movie.rating || 'N/A'));
            if (movie.country?.[0]) {
                meta.appendChild(createMetaItem('globe', movie.country[0].charAt(0).toUpperCase() + movie.country[0].slice(1).toLowerCase()));
            }

            const genres = document.createElement('div');
            genres.className = 'film-genres';
            if (Array.isArray(movie.genres)) {
                movie.genres.forEach(genre => {
                    const genreDiv = document.createElement('div');
                    genreDiv.className = 'film-genre';
                    genreDiv.textContent = genre;
                    genreDiv.onclick = () => searchByGenre(genre);
                    genres.appendChild(genreDiv);
                });
            }

            const languages = document.createElement('div');
            languages.className = 'film-languages';
            if (Array.isArray(movie.language)) {
                movie.language.forEach(lang => {
                    const langDiv = document.createElement('div');
                    langDiv.className = 'film-language';
                    if (lang === "Türkçe Dublaj") {
                        langDiv.innerHTML = `<img src="/resim/flag-tr.png" alt="TR" class="flag-icon"> Dublaj`;
                    } else if (lang === "Türkçe Altyazı") {
                        langDiv.innerHTML = `<i class="fas fa-closed-captioning"></i> Altyazı`;
                    } else if (lang === "Yerli") {
                        langDiv.innerHTML = `<img src="/resim/flag-tr.png" alt="TR" class="flag-icon"> Yerli`;
                    } else {
                        langDiv.textContent = lang;
                    }
                    languages.appendChild(langDiv);
                });
            }

            const plot = document.createElement('div');
            plot.className = 'film-plot';
            plot.innerHTML = `<strong>Konusu:</strong> ${movie.plot || 'Konu bilgisi mevcut değil.'}`;

            info.append(title, meta, genres, languages, plot);
            hero.append(posterWrapper, info);
            container.innerHTML = '';
            container.appendChild(hero);

            document.title = `${movie.title || 'İçerik'} (${movie.year || 'N/A'}) - DİZİT`;
        }

        function createMetaItem(icon, text) {
            const item = document.createElement('div');
            item.className = 'film-meta-item';
            item.innerHTML = `<i class="fas fa-${icon}"></i> ${text}`;
            return item;
        }

        async function watchMovie(movieId, movieTitle, videoSrc) {
            const playerContainer = document.getElementById('player-container');
            playerContainer.innerHTML = '';

            let isLiked = false;
            let isDisliked = false;
            let isWatched = false;
            let isFavorited = false;
            let isWatchLater = false;
            let likeCount = 0;
            let dislikeCount = 0;

            if (isLoggedIn) {
                try {
                    const res = await fetch(`${apiUrl}/api/movie-status/${movieId}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        isLiked = data.isLiked;
                        isDisliked = data.isDisliked;
                        isWatched = data.isWatched;
                        isFavorited = data.isFavorited;
                        isWatchLater = data.isWatchLater;
                        likeCount = data.likeCount;
                        dislikeCount = data.dislikeCount;
                    }
                } catch (error) {
                    console.error('Status fetch error:', error);
                }
            } else {
                try {
                    const res = await fetch(`${apiUrl}/api/public/movie-status/${movieId}`);
                    if (res.ok) {
                        const data = await res.json();
                        likeCount = data.likeCount;
                        dislikeCount = data.dislikeCount;
                    }
                } catch (error) {
                    console.error('Public status fetch error:', error);
                }
            }

            playerContainer.innerHTML = `
                <div class="player-box">
                    <div class="player-title">
                        <h2 class="film-name">${movieTitle || 'Bilinmeyen İçerik'}</h2>
                        <p class="runtime-info">${movieCache.runtime || 'N/A'}</p>
                    </div>
                    ${movieCache.premium && !isPremiumUser ? `
                        <div class="premium-message">
                            <i class="fas fa-lock"></i>
                            <p>İçerik Telifli Olduğu İçin Premium Üyelik Satın Alınız</p>
                            <button onclick="window.location.href='/premium.html'">Üyelik Satın Al</button>
                        </div>
                    ` : `
                        <div class="video-options" id="video-options"></div>
                        <div class="video-wrapper">
                            <iframe id="movie-player" src="${videoSrc || 'about:blank'}" allowfullscreen></iframe>
                        </div>
                        <div class="player-actions">
                            <button class="like-btn ${isLoggedIn ? '' : 'disabled'} ${isLiked ? 'active' : ''}" id="like-btn-${movieId}">
                                <i class="${isLiked ? 'fas' : 'far'} fa-thumbs-up"></i> Beğen: ${likeCount}
                            </button>
                            <button class="dislike-btn ${isLoggedIn ? '' : 'disabled'} ${isDisliked ? 'active' : ''}" id="dislike-btn-${movieId}">
                                <i class="${isDisliked ? 'fas' : 'far'} fa-thumbs-down"></i> Beğenme: ${dislikeCount}
                            </button>
                            <button class="favorite-btn ${isLoggedIn ? '' : 'disabled'} ${isFavorited ? 'active' : ''}" id="favorite-btn-${movieId}">
                                <i class="${isFavorited ? 'fas' : 'far'} fa-heart"></i> ${isFavorited ? 'Favorilerden Çıkar' : 'Favorilere Ekle'}
                            </button>
                            <button class="watch-later-btn ${isLoggedIn ? '' : 'disabled'} ${isWatchLater ? 'active' : ''}" id="watch-later-btn-${movieId}">
                                <i class="${isWatchLater ? 'fas' : 'far'} fa-clock"></i> ${isWatchLater ? 'Daha Sonra İzleden Çıkar' : 'Daha Sonra İzle'}
                            </button>
                            <label class="watched-checkbox ${isLoggedIn ? '' : 'disabled'}">
                                <input type="checkbox" id="watched-checkbox-${movieId}" ${isWatched ? 'checked' : ''} ${isLoggedIn ? '' : 'disabled'}>
                                <span class="checkbox-custom"></span>
                                İzledim
                            </label>
                        </div>
                    `}
                </div>
            `;

            if (!(movieCache.premium && !isPremiumUser)) {
                const videoOptions = document.getElementById('video-options');
                if (movieCache.videoSrc && Array.isArray(movieCache.videoSrc)) {
                    movieCache.videoSrc.forEach((src, index) => {
                        const btn = document.createElement('button');
                        btn.className = `video-option-btn ${index === 0 ? 'active' : ''}`;
                        if (src.type.includes("Dublaj") && src.type.includes("Altyazı")) {
                            btn.innerHTML = `<span class="icon-left"><img src="/resim/flag-tr.png" alt="TR" class="flag-icon"><i class="fas fa-closed-captioning"></i></span> Dublaj ve Altyazı`;
                        } else {
                            btn.innerHTML = src.type.includes("Dublaj") ? `<img src="/resim/flag-tr.png" alt="TR" class="flag-icon"> Dublaj` :
                                            src.type.includes("Altyazı") ? `<i class="fas fa-closed-captioning"></i> Altyazı` :
                                            src.type.includes("Yerli") ? `<img src="/resim/flag-tr.png" alt="TR" class="flag-icon"> Yerli` : src.type;
                        }
                        btn.onclick = () => {
                            document.querySelectorAll('.video-option-btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            document.getElementById('movie-player').src = src.src || 'about:blank';
                        };
                        videoOptions.appendChild(btn);
                    });
                }
            }

            const likeBtn = document.getElementById(`like-btn-${movieId}`);
            const dislikeBtn = document.getElementById(`dislike-btn-${movieId}`);
            const favoriteBtn = document.getElementById(`favorite-btn-${movieId}`);
            const watchedCheckbox = document.getElementById(`watched-checkbox-${movieId}`);
            const watchLaterBtn = document.getElementById(`watch-later-btn-${movieId}`);

            likeBtn.addEventListener('click', async () => {
                if (!isLoggedIn) {
                    openAuthModal('login');
                    return;
                }
                try {
                    const res = await fetch(`${apiUrl}/api/movie-like`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ movieId })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        likeBtn.classList.toggle('active', data.isLiked);
                        dislikeBtn.classList.toggle('active', data.isDisliked);
                        likeBtn.innerHTML = `<i class="${data.isLiked ? 'fas' : 'far'} fa-thumbs-up"></i> Beğen: ${data.likeCount}`;
                        dislikeBtn.innerHTML = `<i class="${data.isDisliked ? 'fas' : 'far'} fa-thumbs-down"></i> Beğenme: ${data.dislikeCount}`;
                        showToast(data.isLiked ? 'İçerik beğenildi!' : 'Beğeni kaldırıldı.', 'success');
                    } else {
                        showToast(data.error || 'Beğeni işlemi başarısız', 'error');
                        if (data.error.includes('token')) logout();
                    }
                } catch (error) {
                    showToast('Sunucuyla bağlantı hatası', 'error');
                }
            });

            dislikeBtn.addEventListener('click', async () => {
                if (!isLoggedIn) {
                    openAuthModal('login');
                    return;
                }
                try {
                    const res = await fetch(`${apiUrl}/api/movie-dislike`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ movieId })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        dislikeBtn.classList.toggle('active', data.isDisliked);
                        likeBtn.classList.toggle('active', data.isLiked);
                        likeBtn.innerHTML = `<i class="${data.isLiked ? 'fas' : 'far'} fa-thumbs-up"></i> Beğen: ${data.likeCount}`;
                        dislikeBtn.innerHTML = `<i class="${data.isDisliked ? 'fas' : 'far'} fa-thumbs-down"></i> Beğenme: ${data.dislikeCount}`;
                        showToast(data.isDisliked ? 'İçerik beğenilmedi!' : 'Beğenmeme kaldırıldı.', 'success');
                    } else {
                        showToast(data.error || 'Beğenmeme işlemi başarısız', 'error');
                        if (data.error.includes('token')) logout();
                    }
                } catch (error) {
                    showToast('Sunucuyla bağlantı hatası', 'error');
                }
            });

            favoriteBtn.addEventListener('click', async () => {
                if (!isLoggedIn) {
                    showToast('Favorilere eklemek için giriş yapmalısınız', 'error');
                    openAuthModal('login');
                    return;
                }
                if (!movieId) {
                    showToast('Hata: Film ID bulunamadı', 'error');
                    console.error('Favori ekleme hatası: movieId eksik');
                    return;
                }
                const token = localStorage.getItem('token');
                if (!token) {
                    showToast('Oturumunuz sona erdi, lütfen tekrar giriş yapın', 'error');
                    logout();
                    return;
                }
                try {
                    console.log('Favori ekleme isteği gönderiliyor:', { movieId });
                    const res = await fetch(`${apiUrl}/api/favorite`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ movieId })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        isFavorited = data.isFavorited;
                        favoriteBtn.classList.toggle('active', isFavorited);
                        favoriteBtn.innerHTML = `<i class="${isFavorited ? 'fas' : 'far'} fa-heart"></i> ${isFavorited ? 'Favorilerden Çıkar' : 'Favorilere Ekle'}`;
                        showToast(isFavorited ? 'İçerik favorilere eklendi!' : 'İçerik favorilerden çıkarıldı.', 'success');
                        if (isFavorited) {
                            displaySimilarMovies(movieCache);
                        }
                    } else {
                        console.error('Favori ekleme yanıtı:', data);
                        if (data.error.includes('Veri doğrulama hatası')) {
                            showToast('Geçersiz film ID formatı', 'error');
                        } else if (data.error.includes('Film veya dizi bulunamadı')) {
                            showToast('Bu içerik bulunamadı, lütfen başka bir içerik deneyin', 'error');
                        } else if (data.error.includes('token') || res.status === 401) {
                            showToast('Oturumunuz sona erdi, lütfen tekrar giriş yapın', 'error');
                            logout();
                        } else {
                            showToast(data.error || 'Favori ekleme başarısız', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Favori ekleme hatası:', error.message);
                    showToast('Sunucuyla bağlantı hatası: ' + error.message, 'error');
                }
            });

            watchLaterBtn.addEventListener('click', async () => {
                if (!isLoggedIn) {
                    showToast('Daha sonra izle listesine eklemek için giriş yapmalısınız', 'error');
                    openAuthModal('login');
                    return;
                }
                try {
                    const res = await fetch(`${apiUrl}/api/watch-later`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ movieId })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        isWatchLater = data.isWatchLater;
                        watchLaterBtn.classList.toggle('active', isWatchLater);
                        watchLaterBtn.innerHTML = `<i class="${isWatchLater ? 'fas' : 'far'} fa-clock"></i> ${isWatchLater ? 'Daha Sonra İzle\'den Çıkar' : 'Daha Sonra İzle'}`;
                        showToast(isWatchLater ? 'İçerik daha sonra izle listesine eklendi!' : 'İçerik daha sonra izle listesinden çıkarıldı.', 'success');
                    } else {
                        console.error('Daha sonra izle ekleme yanıtı:', data);
                        if (data.error.includes('token') || res.status === 401) {
                            showToast('Oturumunuz sona erdi, lütfen tekrar giriş yapın', 'error');
                            logout();
                        } else {
                            showToast(data.error || 'Daha sonra izle ekleme başarısız', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Daha sonra izle ekleme hatası:', error.message);
                    showToast('Sunucuyla bağlantı hatası: ' + error.message, 'error');
                }
            });

            watchedCheckbox.addEventListener('change', async () => {
                if (!isLoggedIn) {
                    openAuthModal('login');
                    watchedCheckbox.checked = false;
                    return;
                }
                try {
                    const res = await fetch(`${apiUrl}/api/movie-watched`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ movieId })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        showToast(data.isWatched ? 'İzledi olarak işaretlendi!' : 'İzlenme durumu kaldırıldı.', 'success');
                        if (data.isWatched) {
                            displaySimilarMovies(movieCache);
                        }
                    } else {
                        showToast(data.error || 'İzleme durumu güncellenemedi', 'error');
                        watchedCheckbox.checked = !watchedCheckbox.checked;
                    }
                } catch (error) {
                    showToast('Sunucuyla bağlantı hatası', 'error');
                    watchedCheckbox.checked = !watchedCheckbox.checked;
                }
            });

            window.scrollTo({ top: playerContainer.offsetTop - 100, behavior: 'smooth' });
        }

        async function displaySimilarMovies(currentMovie) {
            const container = document.getElementById('similar-movies');
            container.innerHTML = `
                <h2 class="section-title">Benzer ${currentMovie.type === 'film' ? 'Filmler' : 'Diziler'}</h2>
                <div class="poster-slider" id="similar-slider">
                    <div class="slider-container" id="similar-slider-container">
                        <p>Yükleniyor...</p>
                    </div>
                    <button class="slider-prev" id="similar-prev"><i class="fas fa-chevron-left"></i></button>
                    <button class="slider-next" id="similar-next"><i class="fas fa-chevron-right"></i></button>
                </div>
            `;

            try {
                const token = localStorage.getItem('token');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                const res = await fetch(`${apiUrl}/api/similar/${currentMovie.id}?type=${currentMovie.type}`, { headers });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'Benzer içerikler alınamadı');
                }
                const movies = await res.json();
                if (!Array.isArray(movies) || movies.length === 0) {
                    document.getElementById('similar-slider-container').innerHTML = '<p>Benzer içerik bulunamadı.</p>';
                    return;
                }
                displayItems(movies, 'similar-slider-container');
            } catch (error) {
                console.error('Similar movies error:', error.message);
                document.getElementById('similar-slider-container').innerHTML = '<p>Benzer içerikler yüklenemedi.</p>';
                showToast('Benzer içerikler yüklenemedi', 'error');
            }
        }

        function displayItems(items, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach(item => {
                const badge = item.language?.includes("Yerli") ? '<span class="language-badge"><img src="/resim/flag-tr.png" alt="TR" class="flag-icon"> Yerli</span>' :
                             item.language?.includes("Türkçe Dublaj") && item.language?.includes("Türkçe Altyazı") ? '<span class="language-badge"><img src="/resim/flag-tr.png" alt="TR" class="flag-icon"> Dublaj <i class="fas fa-closed-captioning"></i> Altyazı</span>' :
                             item.language?.includes("Türkçe Dublaj") ? '<span class="language-badge"><img src="/resim/flag-tr.png" alt="TR" class="flag-icon"> Dublaj</span>' :
                             item.language?.includes("Türkçe Altyazı") ? '<span class="language-badge"><i class="fas fa-closed-captioning"></i> Altyazı</span>' : '';
                const premiumIcon = item.premium ? '<i class="fas fa-crown premium-icon"></i>' : '';
                const card = document.createElement('div');
                card.className = 'slider-item';
                card.innerHTML = `
                    <div class="poster-wrapper">
                        <img src="${item.poster || 'https://via.placeholder.com/300x450'}" alt="${item.title}" class="slider-poster">
                        ${badge}
                        ${premiumIcon}
                    </div>
                    <div class="slider-info">
                        <h3 class="slider-title">${item.title || 'Bilinmeyen İçerik'}</h3>
                        <div class="slider-meta">
                            <span>${item.year || 'N/A'}</span>
                            <div class="imdb-rating"><i class="fas fa-star"></i> ${item.rating || 'N/A'}</div>
                        </div>
                    </div>
                `;
                card.onclick = () => window.location.href = `/film/${item.id}`;
                container.appendChild(card);
            });

            initSlider('similar-slider-container', 'similar-prev', 'similar-next');
        }

        function initSlider(sliderId, prevBtnId, nextBtnId) {
            const container = document.getElementById(sliderId);
            const prevBtn = document.getElementById(prevBtnId);
            const nextBtn = document.getElementById(nextBtnId);
            let isDragging = false;
            let startX = 0;
            let scrollLeft = 0;

            function updateButtons() {
                prevBtn.style.display = container.scrollLeft <= 0 ? 'none' : 'block';
                nextBtn.style.display = container.scrollLeft >= container.scrollWidth - container.clientWidth - 1 ? 'none' : 'block';
            }

            const scrollStep = 220;
            nextBtn.onclick = () => {
                container.scrollTo({
                    left: container.scrollLeft + scrollStep,
                    behavior: 'smooth'
                });
                setTimeout(updateButtons, 300);
            };

            prevBtn.onclick = () => {
                container.scrollTo({
                    left: container.scrollLeft - scrollStep,
                    behavior: 'smooth'
                });
                setTimeout(updateButtons, 300);
            };

            container.addEventListener('touchstart', e => {
                isDragging = true;
                startX = e.touches[0].clientX;
                scrollLeft = container.scrollLeft;
            });

            container.addEventListener('touchmove', e => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.touches[0].clientX;
                const deltaX = x - startX;
                container.scrollLeft = scrollLeft - deltaX;
            });

            container.addEventListener('touchend', () => {
                isDragging = false;
            });

            container.addEventListener('wheel', e => {
                e.preventDefault();
                container.scrollTo({
                    left: container.scrollLeft + e.deltaY * 2,
                    behavior: 'smooth'
                });
                setTimeout(updateButtons, 200);
            });

            container.addEventListener('scroll', updateButtons);
            updateButtons();
        }

        function enableDynamicTouchSwipe() {
            const sliderContainer = document.getElementById('similar-movies-container');
            if (!sliderContainer) return;
            let startX = 0;
            let scrollLeftStart = 0;
            let isDragging = false;
            let velocity = 0;
            let lastX = 0;
            let lastTime = 0;
            let animationFrame = null;
            sliderContainer.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                scrollLeftStart = sliderContainer.scrollLeft;
                isDragging = true;
                velocity = 0;
                lastX = startX;
                lastTime = Date.now();
                if (animationFrame) cancelAnimationFrame(animationFrame);
            });
            sliderContainer.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.touches[0].clientX;
                const currentTime = Date.now();
                const deltaX = x - lastX;
                const deltaTime = currentTime - lastTime || 1;
                velocity = (deltaX / deltaTime) * 1000;
                lastX = x;
                lastTime = currentTime;
                const walk = (startX - x) * 2;
                sliderContainer.scrollLeft = scrollLeftStart + walk;
            });
            sliderContainer.addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                const momentum = () => {
                    if (Math.abs(velocity) < 0.1) return;
                    sliderContainer.scrollLeft += velocity * 0.016;
                    velocity *= 0.95;
                    animationFrame = requestAnimationFrame(momentum);
                };
                animationFrame = requestAnimationFrame(momentum);
            });
            sliderContainer.addEventListener('mousedown', (e) => {
                if (window.innerWidth <= 768) {
                    e.preventDefault();
                }
            });
        }

        function searchByGenre(genre) {
            const searchOverlay = document.getElementById('search-overlay');
            const searchOverlayInput = document.getElementById('search-overlay-input');
            searchOverlay.classList.add('active');
            searchOverlayInput.value = genre;
            searchOverlayInput.focus();
            performSearch(genre);
        }

        async function performSearch(query) {
            const searchResults = document.getElementById('search-results');
            if (!query) {
                searchResults.innerHTML = '';
                return;
            }
            try {
                const res = await fetch(`${apiUrl}/api/search?q=${encodeURIComponent(query)}&limit=7&fields=title,title2,type,poster,year,rating,genres,premium`);
                if (!res.ok) throw new Error('Arama başarısız');
                let data = await res.json();
                data = data.filter(item => 
                    item.title?.toLowerCase().includes(query.toLowerCase()) || 
                    item.title2?.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 7);
                console.log('Arama sonuçları:', data);
                displaySearchResults(data);
            } catch (error) {
                searchResults.innerHTML = '<p>Sonuç bulunamadı.</p>';
                showToast('Arama başarısız', 'error');
                console.error('Arama hatası:', error);
            }
        }

        function displaySearchResults(results) {
            const searchResults = document.getElementById('search-results');
            if (!searchResults) return;
            searchResults.innerHTML = results.length ? '' : '<p>Sonuç bulunamadı.</p>';

            results.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'search-result-item';
                const premiumIcon = item.premium ? '<i class="fas fa-crown premium-icon"></i>' : '';
                itemEl.innerHTML = `
                    <div class="poster-wrapper">
                        <img src="${item.poster || 'https://via.placeholder.com/150'}" alt="${item.title}" class="search-result-poster">
                        ${premiumIcon}
                    </div>
                    <div class="search-result-info">
                        <div class="search-result-title">
                            ${item.title || 'Bilinmeyen İçerik'}
                            ${item.title2 ? `<span class="search-result-title2">(${item.title2})</span>` : ''}
                        </div>
                        <div class="search-result-year">${item.year || 'N/A'}</div>
                        <div class="search-result-genres">${Array.isArray(item.genres) ? item.genres.join(', ') : 'N/A'}</div>
                    </div>
                `;
                itemEl.onclick = () => window.location.href = item.type === 'dizi' ? `/dizi/${item.id}` : `/film/${item.id}`;
                searchResults.appendChild(itemEl);
            });
        }

        async function displayRelatedSeries(movie) {
            const relatedSeriesSection = document.getElementById('related-series');
            const relatedSeriesList = document.getElementById('related-series-list');

            if (!movie.relatedSeriesDetails || movie.relatedSeriesDetails.length === 0) {
                relatedSeriesSection.style.display = 'none';
                return;
            }

            relatedSeriesSection.style.display = 'block';
            relatedSeriesList.classList.add('loading');
            relatedSeriesList.innerHTML = '';

            const ids = movie.relatedSeriesDetails.map(item => item.id);
            let statuses = {};

            if (isLoggedIn && ids.length > 0) {
                try {
                    const res = await fetch(`${apiUrl}/api/movie-status/bulk`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ ids })
                    });
                    if (res.ok) {
                        statuses = await res.json();
                    } else {
                        console.error('Toplu izlenme durumu alınamadı:', res.status);
                    }
                } catch (error) {
                    console.error('Toplu izlenme durumu hatası:', error);
                }
            }

            relatedSeriesList.classList.remove('loading');

            movie.relatedSeriesDetails.forEach(item => {
                const isActive = item.id === movie.id;
                const isWatched = statuses[item.id]?.isWatched || false;
                const premiumIcon = item.premium ? '<i class="fas fa-crown premium-icon"></i>' : '';

                const card = document.createElement('div');
                card.className = `related-series-item ${isActive ? 'active' : ''}`;
                card.innerHTML = `
                    <h3 class="related-series-item-title">
                        <i class="fas fa-film"></i> ${item.title || 'Bilinmeyen İçerik'}
                        ${isWatched ? '<i class="fas fa-check watched-icon" title="İzlendi"></i>' : ''}
                        ${premiumIcon}
                    </h3>
                    <div class="related-series-item-meta">
                        <span><i class="fas fa-calendar"></i> ${item.year || 'N/A'}</span>
                        <span><i class="fas fa-star"></i> ${item.rating || 'N/A'}</span>
                    </div>
                `;
                card.onclick = () => {
                    window.location.href = `/film/${item.id}`;
                };
                relatedSeriesList.appendChild(card);
            });
        }

        async function deleteComment(commentId) {
  try {
    const response = await fetch(`${apiUrl}/api/comments/${commentId}`, {
      method: "DELETE",
      headers: {
        "Authorization": `Bearer ${localStorage.getItem("token")}`
      }
    });

    const data = await response.json();

    if (!response.ok) {
      showToast(data.error || "Yorum silinemedi.", "error");
      return;
    }

    // Backend başarılı yanıt dönerse DOM'dan yorumu kaldır
    document.getElementById(`comment-${commentId}`)?.remove();
    showToast(data.message, "success");

  } catch (error) {
    console.error("Yorum silme hatası:", error.message);
    showToast("Yorum silinirken bir hata oluştu.", "error");
  }
}



        // Yorum Bölümü Fonksiyonları
        function updateCommentSectionVisibility() {
            const commentFormContainer = document.getElementById('comment-form-container');
            const loginPrompt = document.getElementById('login-prompt');
            if (isLoggedIn) {
                commentFormContainer.style.display = 'block';
                loginPrompt.style.display = 'none';
            } else {
                commentFormContainer.style.display = 'none';
                loginPrompt.style.display = 'block';
            }
        }

        // Zaman Formatlama Fonksiyonu
        function formatTimeAgo(date) {
            const now = new Date();
            const commentDate = new Date(date);
            const diffInSeconds = Math.floor((now - commentDate) / 1000);

            if (diffInSeconds < 3600) { // 1 saat
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes} dakika önce`;
            } else if (diffInSeconds < 86400) { // 1 gün
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours} saat önce`;
            } else if (diffInSeconds < 604800) { // 7 gün
                const days = Math.floor(diffInSeconds / 86400);
                return `${days} gün önce`;
            } else {
                const day = String(commentDate.getDate()).padStart(2, '0');
                const month = String(commentDate.getMonth() + 1).padStart(2, '0');
                const year = commentDate.getFullYear();
                return `${day}.${month}.${year}`;
            }
        }

async function loadComments() {
    if (!movieCache || !movieCache.id) return;
    try {
        const headers = isLoggedIn ? { 'Authorization': `Bearer ${localStorage.getItem('token')}` } : {};
        const response = await fetch(`${apiUrl}/api/comments/${movieCache.id}`, { headers });
        const comments = await response.json();
        console.log('API Comments:', JSON.stringify(comments, null, 2));
        const commentsList = document.getElementById('comments-list');
         commentsList.innerHTML = 'Yorumlar yükleniyor...';
        commentsList.innerHTML = '';
        comments.forEach(comment => {
            commentsList.appendChild(renderComment(comment));
        });
    } catch (error) {
        console.error('Yorumları yükleme hatası:', error);
        showToast('Yorumlar yüklenirken bir hata oluştu', 'error');
    }
}

// 🔧 GÜNCELLENMİŞ YANIT GÖSTERME DAVRANIŞI
function renderComment(comment, isReply = false) {
    const commentDiv = document.createElement('div');
    commentDiv.className = `comment ${isReply ? 'reply' : ''}`;
    const userId = localStorage.getItem('userId');
    const isLiked = userId && comment.likes.includes(userId);
    const isDisliked = userId && comment.dislikes.includes(userId);
    const isPremium = comment.userId?.isPremium || false;

    commentDiv.innerHTML = `
        <div class="comment-header">
            <img src="${comment.userId?.avatar || '/resim/avatar/user.png'}" alt="Avatar" onerror="this.src='/resim/avatar/user.png'">
            <a href="/kullanici.html?kullanici=${comment.userId?.username}" class="username-link">${comment.userId?.username || 'Bilinmeyen Kullanıcı'}</a>
            ${isPremium ? '<i class="fas fa-crown premium-comment-icon"></i>' : ''}
            <span class="comment-time">${formatTimeAgo(comment.createdAt)}</span>
        </div>
        <div class="comment-content">${comment.content}</div>
     <div class="comment-actions">
    <button onclick="toggleLikeComment('${comment._id}', ${isLiked})" class="${isLoggedIn ? '' : 'disabled'}">
        <i class="${isLiked ? 'fas' : 'far'} fa-thumbs-up"></i> <span>${comment.likes.length}</span>
    </button>
    <button onclick="toggleDislikeComment('${comment._id}', ${isDisliked})" class="${isLoggedIn ? '' : 'disabled'}">
        <i class="${isDisliked ? 'fas' : 'far'} fa-thumbs-down"></i> <span>${comment.dislikes.length}</span>
    </button>
    <button onclick="toggleReplyForm('${comment._id}')"><i class="fas fa-reply"></i> Yanıtla</button>

    ${comment.userId?._id === localStorage.getItem('userId') ? `
        <button onclick="deleteComment('${comment._id}')"><i class="fas fa-trash"></i> Sil</button>
    ` : ''}
</div>

        <div class="reply-form-container" id="reply-form-${comment._id}">
            <form onsubmit="postReply(event, '${comment._id}')">
                <textarea placeholder="Yanıtınızı yazın..." required></textarea>
                <button type="submit">Yanıt Gönder</button>
            </form>
        </div>
    `;

    if (comment.replies && comment.replies.length > 0) {
        const repliesContainer = document.createElement('div');
        repliesContainer.className = 'replies';
        repliesContainer.style.display = 'none';

        const toggleButton = document.createElement('button');
        toggleButton.className = 'replies-toggle';
        toggleButton.innerHTML = `<i class="fas fa-chevron-down"></i> ${comment.replies.length} yanıtı göster`;

        let repliesLoaded = false;

        toggleButton.onclick = () => {
            const showing = repliesContainer.style.display === 'block';
            if (showing) {
                repliesContainer.style.display = 'none';
                toggleButton.innerHTML = `<i class="fas fa-chevron-down"></i> ${comment.replies.length} yanıtı göster`;
            } else {
                if (!repliesLoaded) {
                    comment.replies.forEach(reply => {
                        repliesContainer.appendChild(renderComment(reply, true));
                    });
                    repliesLoaded = true;
                }
                repliesContainer.style.display = 'block';
                toggleButton.innerHTML = `<i class="fas fa-chevron-up"></i> Yanıtları gizle`;
            }
        };

        commentDiv.appendChild(toggleButton);
        commentDiv.appendChild(repliesContainer);
    }

    return commentDiv;
}

        function toggleReplyForm(commentId) {
            if (!isLoggedIn) {
                showToast('Yanıt yazmak için giriş yapın', 'error');
                openAuthModal('login');
                return;
            }
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            replyForm.classList.toggle('active');
        }

        async function postComment(event) {
            event.preventDefault();
            if (!isLoggedIn) {
                showToast('Yorum yazmak için giriş yapın', 'error');
                openAuthModal('login');
                return;
            }
            const content = document.getElementById('comment-content').value.trim();
            if (!content) {
                showToast('Yorum içeriği boş olamaz', 'error');
                return;
            }
            try {
                const response = await fetch(`${apiUrl}/api/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ movieId: movieCache.id, content })
                });
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('comment-content').value = '';
                    loadComments();
                    showToast('Yorum başarıyla eklendi', 'success');
                } else {
                    showToast(data.error || 'Yorum eklenirken bir hata oluştu', 'error');
                    if (data.error.includes('token')) logout();
                }
            } catch (error) {
                console.error('Yorum ekleme hatası:', error);
                showToast('Yorum eklenirken bir hata oluştu', 'error');
            }
        }

        async function postReply(event, commentId) {
    event.preventDefault();
    if (!isLoggedIn) {
        showToast('Yanıt yazmak için giriş yapın', 'error');
        openAuthModal('login');
        return;
    }
    const form = event.target;
    const content = form.querySelector('textarea').value.trim();
    if (!content) {
        showToast('Yanıt içeriği boş olamaz', 'error');
        return;
    }
    try {
        const response = await fetch(`${apiUrl}/api/comments/${commentId}/reply`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ content })
        });
        const data = await response.json();
        if (response.ok) {
            form.querySelector('textarea').value = '';
            form.parentElement.classList.remove('active');
            await loadComments(); // Yorumları yeniden yükle
            showToast('Yanıt başarıyla eklendi', 'success');
        } else {
            showToast(data.error || 'Yanıt eklenirken bir hata oluştu', 'error');
            if (data.error.includes('token')) logout();
        }
    } catch (error) {
        console.error('Yanıt ekleme hatası:', error);
        showToast('Yanıt eklenirken bir hata oluştu', 'error');
    }
}

        async function toggleLikeComment(commentId, isLiked) {
            if (!isLoggedIn) {
                showToast('Beğenmek için giriş yapın', 'error');
                openAuthModal('login');
                return;
            }
            try {
                const response = await fetch(`${apiUrl}/api/comments/${commentId}/like`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    loadComments();
                    showToast(data.isLiked ? 'Yorum beğenildi!' : 'Beğeni kaldırıldı.', 'success');
                } else {
                    showToast(data.error || 'Beğeni işlemi başarısız', 'error');
                    if (data.error.includes('token')) logout();
                }
            } catch (error) {
                console.error('Beğeni hatası:', error);
                showToast('Beğeni işlemi sırasında bir hata oluştu', 'error');
            }
        }

        async function toggleDislikeComment(commentId, isDisliked) {
            if (!isLoggedIn) {
                showToast('Beğenmemek için giriş yapın', 'error');
                openAuthModal('login');
                return;
            }
            try {
                const response = await fetch(`${apiUrl}/api/comments/${commentId}/dislike`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    loadComments();
                    showToast(data.isDisliked ? 'Yorum beğenilmedi!' : 'Beğenmeme kaldırıldı.', 'success');
                } else {
                    showToast(data.error || 'Beğenmeme işlemi başarısız', 'error');
                    if (data.error.includes('token')) logout();
                }
            } catch (error) {
                console.error('Beğenmeme hatası:', error);
                showToast('Beğenmeme işlemi sırasında bir hata oluştu', 'error');
            }
        }

        async function init() {
            await fetchApiUrl();
            await checkAuth();
            await checkPremiumStatus();
            let movieId = getMovieIdFromDynamicUrl();
            if (!movieId) {
                const urlParams = new URLSearchParams(window.location.search);
                movieId = urlParams.get('id');
                if (movieId) {
                    window.location.replace(`/film/${movieId}`);
                    return;
                }
                displayErrorPage();
                return;
            }
            const movie = await fetchMovieById(movieId);
            if (!movie) {
                displayErrorPage();
                return;
            }
            movieCache = movie;
            displayMovieDetails(movie);
            watchMovie(movie.id, movie.title, movie.videoSrc?.[0]?.src);
            displayRelatedSeries(movie);
            displaySimilarMovies(movie);
            updateCommentSectionVisibility();
            loadComments();

            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.classList.add('hidden');
            setTimeout(() => loadingScreen.remove(), 500);

            document.getElementById('search-input').onfocus = () => {
                const overlay = document.getElementById('search-overlay');
                overlay.classList.add('active');
                document.getElementById('search-overlay-input').focus();
            };

            document.getElementById('search-overlay-input').oninput = () => {
                const query = document.getElementById('search-overlay-input').value.trim().toLowerCase();
                performSearch(query);
            };

            document.getElementById('close-overlay').onclick = () => {
                const overlay = document.getElementById('search-overlay');
                overlay.classList.remove('active');
                document.getElementById('search-input').value = '';
                document.getElementById('search-overlay-input').value = '';
                document.getElementById('search-results').innerHTML = '';
            };

            document.getElementById('burger-menu').onclick = () => {
                document.getElementById('nav-container').classList.toggle('active');
            };

            window.addEventListener('resize', () => {
                if (window.innerWidth > 768 && document.getElementById('nav-container').classList.contains('active')) {
                    document.getElementById('nav-container').classList.remove('active');
                }
            });

            document.addEventListener('click', (event) => {
                const dropdown = document.getElementById('profile-dropdown');
                const profileCard = document.querySelector('.profile-card');
                if (!dropdown.contains(event.target) && !profileCard.contains(event.target)) {
                    closeProfileMenu();
                }
            });

            document.addEventListener('touchstart', (event) => {
                const dropdown = document.getElementById('profile-dropdown');
                const profileCard = document.querySelector('.profile-card');
                if (!dropdown.contains(event.target) && !profileCard.contains(event.target)) {
                    closeProfileMenu();
                }
            });

            document.getElementById('comment-form').addEventListener('submit', postComment);
        }

        document.addEventListener('DOMContentLoaded', () => {
            enableDynamicTouchSwipe();
            init();
        });

          document.addEventListener('click', function (e) {
    if (e.target.classList.contains('replies-toggle')) {
      const commentBox = e.target.closest('.comment');
      const repliesContainer = commentBox.querySelector('.replies');

      if (repliesContainer) {
        repliesContainer.classList.toggle('hidden');
        e.target.innerHTML = repliesContainer.classList.contains('hidden') 
          ? '<i class="fas fa-chevron-down"></i> Yanıtları Göster' 
          : '<i class="fas fa-chevron-up"></i> Yanıtları Gizle';
      }
    }
  });

  // movieId URL'den çekiliyor
function sendViewEvent() {
    const movieId = movieCache?._id; // Bu _id => MongoDB ObjectId

    fetch(`${apiUrl}/api/movies/${movieId}/view`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${localStorage.getItem("token")}`
      }
    })
    .catch(err => console.error("🚫 Fetch hatası:", err));
  }

  // 5 saniye sonra izlenme saydır
  setTimeout(sendViewEvent, 60000);

    </script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93c063ed9b7fb061',t:'MTc0NjYxNzQ3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
