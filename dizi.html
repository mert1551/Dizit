<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dizi Ä°zle - DÄ°ZÄ°T</title>
    <meta name="description" content="">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/dizi.css?v=1">
    <link rel="icon" href="/resim/dizit-favicon.ico" type="image/x-icon">
    <style>
        /* Premium Icon Styles */
        .premium-icon {
            position: absolute;
            top: 3px;
            right: 3px;
            background: #ffcc00;
            color: #121212;
            padding: 5px;
            border-radius: 50%;
            font-size: 14px;
            z-index: 10;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="curtain-container">
            <div class="curtain-left"></div>
            <div class="curtain-right"></div>
        </div>
        <div class="loading-logo">DÄ°ZÄ°T</div>
        <div class="popcorn-loader">
            <div class="popcorn"></div>
            <div class="popcorn"></div>
            <div class="popcorn"></div>
        </div>
    </div>

    <header id="header">
        <a href="/" class="logo">DÄ°ZÄ°T</a>
        <div class="header-right">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Film veya dizi ara...">
                <button id="search-btn"><i class="fas fa-search"></i></button>
            </div>
            <div class="burger-menu" id="burger-menu">
                <i class="fas fa-bars"></i>
            </div>
        </div>
        <div class="nav-container" id="nav-container">
            <ul class="nav-links">
                <li><a href="/">Anasayfa</a></li>
                <li><a href="/filmler" class="active">Filmler</a></li>
                <li><a href="/diziler">Diziler</a></li>
                <li><a href="/kesfet">KeÅŸfet</a></li>
                <li><a href="/istek-ve-sikayet">Ä°stek ve Åžikayet</a></li>
            </ul>
        </div>
        <div class="profile-wrapper">
            <div class="profile-card" onclick="toggleProfileMenu()">
                <img src="/resim/avatar/user.png" alt="Profile Avatar" title="Profil" class="profile-avatar">
                <span class="profile-username"></span>
                <i class="fas fa-chevron-down profile-arrow"></i>
            </div>
            <div class="profile-dropdown" id="profile-dropdown">
                <ul class="profile-menu">
                    <li><a href="/hesabim.html"><i class="fas fa-user"></i> Profilim</a></li>
                    <li><a href="/ayarlar.html"><i class="fas fa-cog"></i> Ayarlar</a></li>
                    <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Ã‡Ä±kÄ±ÅŸ Yap</a></li>
                </ul>
            </div>
        </div>
    </header>

    <div class="auth-modal" id="auth-modal">
        <div class="auth-modal-content">
            <button class="close-modal" onclick="closeAuthModal()"><i class="fas fa-times"></i></button>
            <div class="auth-tabs">
                <button class="tab-btn active" id="login-tab" onclick="switchTab('login')">GiriÅŸ Yap</button>
                <button class="tab-btn" id="signup-tab" onclick="switchTab('signup')">Ãœye Ol</button>
                <button class="tab-btn" id="forgot-tab" onclick="switchTab('forgot')">Åžifremi Unuttum</button>
            </div>
            <div class="auth-form" id="login-form">
                <h2>GiriÅŸ Yap</h2>
                <form id="login-form-submit" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="login-username">KullanÄ±cÄ± AdÄ±</label>
                        <input type="text" id="login-username" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Parola</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <p class="error-message" id="login-error"></p>
                    <button type="submit" class="auth-submit">GiriÅŸ Yap</button>
                    <p class="forgot-link" onclick="switchTab('forgot')">Åžifrenizi mi unuttunuz?</p>
                </form>
            </div>
            <div class="auth-form" id="signup-form" style="display: none;">
                <h2>Ãœye Ol</h2>
                <form id="signup-form-submit" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label for="signup-username">KullanÄ±cÄ± AdÄ±</label>
                        <input type="text" id="signup-username" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-email">E-posta</label>
                        <input type="email" id="signup-email" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Parola</label>
                        <input type="password" id="signup-password" required oninput="validatePassword()">
                        <p class="password-hint" id="password-hint">Parola en az 8 karakter, 1 bÃ¼yÃ¼k harf, 1 kÃ¼Ã§Ã¼k harf ve 1 rakam iÃ§ermelidir.</p>
                    </div>
                    <div class="form-group">
                        <label for="signup-password-confirm">Parola Tekrar</label>
                        <input type="password" id="signup-password-confirm" required>
                    </div>
                    <p class="error-message" id="signup-error"></p>
                    <button type="submit" class="auth-submit">Ãœye Ol</button>
                </form>
            </div>
            <div class="auth-form" id="forgot-form" style="display: none;">
                <h2>Åžifremi Unuttum</h2>
                <form id="forgot-form-submit" onsubmit="handleForgotPassword(event)">
                    <div class="form-group">
                        <label for="forgot-email">E-posta</label>
                        <input type="email" id="forgot-email" required>
                    </div>
                    <p class="error-message" id="forgot-error"></p>
                    <p class="success-message" id="forgot-success"></p>
                    <button type="submit" class="auth-submit">Åžifre SÄ±fÄ±rlama BaÄŸlantÄ±sÄ± GÃ¶nder</button>
                </form>
            </div>
        </div>
    </div>

    <div class="search-overlay" id="search-overlay">
        <div class="search-overlay-header">
            <input type="text" id="search-overlay-input" placeholder="Film veya dizi ara...">
            <button id="close-overlay" class="close-overlay-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="search-results" id="search-results"></div>
    </div>

    <main>
        <div class="dizi-container" id="dizi-container"></div>
        <section class="player-container" id="player-container"></section>
        <section class="season-section" id="season-section"></section>
        <section class="similar-series" id="similar-series"></section>
    </main>

<footer>
        <div class="footer-content">
            <div class="footer-column">
                <h3>DÄ°ZÄ°T</h3>
                <p>En iyi film ve dizi izleme platformu.</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Â© 2025 DÄ°ZÄ°T. TÃ¼m haklarÄ± saklÄ±dÄ±r.</p>
        </div>
    </footer>

    <script>
        //PLayer
const FILE_EXTENSIONS = ['.m3u8', '.mp4', '.webm', '.mov', '.flv', '.mkv', '.ogg'];

function isFileLink(src = '') {
  const lower = src.split('?')[0].toLowerCase();
  return FILE_EXTENSIONS.some(ext => lower.endsWith(ext));
}

function createPlayer(src) {
  const wrap = document.getElementById('series-player-container');
  if (!wrap) return;

  // Tamamen iÃ§eriÄŸi temizle
  wrap.innerHTML = '';

  // Logo tekrar eklenir
  const logo = document.createElement("img");
  logo.src = "/resim/dizit-logo.png";
  logo.alt = "Logo";
  logo.className = "player-overlay-logo";
  wrap.appendChild(logo);

  // Eski player varsa temizle
  if (window._pjs && typeof window._pjs.api === 'function') {
    try { window._pjs.api('destroy'); } catch (e) {}
  }

  const isFile = /\.(m3u8|mp4|webm|mov|flv|mkv|ogg)(\?.*)?$/.test(src.toLowerCase());

  if (isFile) {
    const div = document.createElement('div');
    div.id = 'playerjs';
    wrap.appendChild(div);

    // Yeni player baÅŸlat
    window._pjs = new Playerjs({
      id: 'playerjs',
      file: src,
      autoplay: false,
      abouttext: "DÄ°ZÄ°T Player 2025"
    });
  } else {
    const iframe = document.createElement('iframe');
    iframe.id = 'series-player';
    iframe.src = src;
    iframe.allowFullscreen = true;
    iframe.scrolling = 'no';
    iframe.frameBorder = '0';
    wrap.appendChild(iframe);
  }
}




        let isLoggedIn = !!localStorage.getItem('token');
        let currentUser = localStorage.getItem('username') || null;
        let seriesCache = null;
        let apiUrl = '';
        let isPremiumUser = false;

        async function fetchApiUrl() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                apiUrl = data.apiUrl || 'http://localhost:3000';
            } catch (error) {
                console.error('API URL alÄ±namadÄ±:', error);
                apiUrl = 'http://localhost:3000';
            }
        }

        async function checkPremiumStatus() {
            if (!isLoggedIn) return false;
            try {
                const res = await fetch(`${apiUrl}/api/check-premium`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    isPremiumUser = data.isPremium;
                    return isPremiumUser;
                } else {
                    isPremiumUser = false;
                    return false;
                }
            } catch (error) {
                console.error('Premium status check error:', error);
                isPremiumUser = false;
                return false;
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function updateProfileAvatar() {
    const profileAvatar = document.querySelector('.profile-avatar');
    const profileUsername = document.querySelector('.profile-username');
    const profileMenu = document.querySelector('.profile-menu'); // menÃ¼ listesi

    if (!isLoggedIn) {
        profileAvatar.src = '/resim/avatar/user.png';
        profileUsername.textContent = 'GiriÅŸ Yap';
        return;
    }

    try {
        const response = await fetch(`${apiUrl}/api/user-profile?t=${Date.now()}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });

        if (!response.ok) {
            if (response.status === 401) {
                showToast('Oturumunuzun sÃ¼resi doldu. LÃ¼tfen yeniden giriÅŸ yapÄ±n.', 'error');
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                isLoggedIn = false;
                currentUser = null;
                openAuthModal('login');
            }
            throw new Error('KullanÄ±cÄ± verileri alÄ±namadÄ±');
        }

        const user = await response.json();
        profileAvatar.src = user.avatar || '/resim/avatar/user.png';
        profileAvatar.onerror = () => {
            profileAvatar.src = '/resim/avatar/user.png';
        };
        profileUsername.textContent = user.username || 'KullanÄ±cÄ±';
        localStorage.setItem('username', user.username);

        // Eski admin panel linki varsa sil
        const existingAdminLink = document.getElementById('admin-panel-link');
        if (existingAdminLink) existingAdminLink.parentElement.remove();

        // Admin kullanÄ±cÄ±ysa menÃ¼ye linki en Ã¼ste ekle
        if (user.isAdmin && profileMenu) {
            const adminItem = document.createElement('li');
            adminItem.innerHTML = `<a id="admin-panel-link" href="admin/admin-panel.html"><i class="fas fa-tools"></i> Admin Panel</a>`;
            profileMenu.insertBefore(adminItem, profileMenu.firstElementChild); // Profilim'in Ã¼stÃ¼ne
        }

    } catch (error) {
        console.error('Profil verileri yÃ¼klenemedi:', error);
        profileAvatar.src = '/resim/avatar/user.png';
        profileUsername.textContent = localStorage.getItem('username') || 'GiriÅŸ Yap';
    }
}


        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                isLoggedIn = false;
                currentUser = null;
                await updateProfileAvatar();
                return false;
            }
            try {
                const res = await fetch(`${apiUrl}/api/verify-token`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    isLoggedIn = true;
                    currentUser = data.username;
                    localStorage.setItem('username', data.username);
                    await updateProfileAvatar();
                    return true;
                } else {
                    localStorage.removeItem('token');
                    localStorage.removeItem('username');
                    isLoggedIn = false;
                    currentUser = null;
                    await updateProfileAvatar();
                    return false;
                }
            } catch (error) {
                console.error('Token doÄŸrulama hatasÄ±:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                isLoggedIn = false;
                currentUser = null;
                await updateProfileAvatar();
                return false;
            }
        }

        function openAuthModal(type = 'login') {
            const modal = document.getElementById('auth-modal');
            modal.classList.add('active');
            switchTab(type);
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').classList.remove('active');
            document.getElementById('login-error').textContent = '';
            document.getElementById('signup-error').textContent = '';
            document.getElementById('forgot-error').textContent = '';
            document.getElementById('forgot-success').textContent = '';
            document.getElementById('login-form-submit').reset();
            document.getElementById('signup-form-submit').reset();
            document.getElementById('forgot-form-submit').reset();
            document.getElementById('password-hint').style.color = '#666';
        }

        function toggleProfileMenu() {
            const dropdown = document.getElementById('profile-dropdown');
            if (!isLoggedIn) {
                openAuthModal('login');
            } else {
                dropdown.classList.toggle('active');
            }
        }

        function closeProfileMenu() {
            const dropdown = document.getElementById('profile-dropdown');
            dropdown.classList.remove('active');
        }

        function switchTab(type) {
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            const forgotTab = document.getElementById('forgot-tab');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const forgotForm = document.getElementById('forgot-form');
            const loginError = document.getElementById('login-error');
            const signupError = document.getElementById('signup-error');
            const forgotError = document.getElementById('forgot-error');
            const forgotSuccess = document.getElementById('forgot-success');

            loginTab.classList.toggle('active', type === 'login');
            signupTab.classList.toggle('active', type === 'signup');
            forgotTab.classList.toggle('active', type === 'forgot');
            loginForm.style.display = type === 'login' ? 'block' : 'none';
            signupForm.style.display = type === 'signup' ? 'block' : 'none';
            forgotForm.style.display = type === 'forgot' ? 'block' : 'none';
            loginError.textContent = '';
            signupError.textContent = '';
            forgotError.textContent = '';
            forgotSuccess.textContent = '';
            document.getElementById('login-form-submit').reset();
            document.getElementById('signup-form-submit').reset();
            document.getElementById('forgot-form-submit').reset();
            document.getElementById('password-hint').style.color = '#666';
        }

        function validatePassword() {
            const password = document.getElementById('signup-password').value;
            const hint = document.getElementById('password-hint');
            const strongPasswordRegex = /^(?=.*[a-z])(?!.*[ÄŸÃ¼ÅŸÃ¶Ã§Ä±])(?=.*[A-Z])(?!.*[ÄžÃœÅžÃ–Ã‡Ä°])(?=.*\d)[A-Za-z\d]{8,}$/;
            if (!strongPasswordRegex.test(password) && password.length > 0) {
                hint.style.color = '#e74c3c';
            } else {
                hint.style.color = '#666';
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            try {
                const res = await fetch(`${apiUrl}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('username', data.username);
                    isLoggedIn = true;
                    currentUser = data.username;
                    errorEl.textContent = '';
                    closeAuthModal();
                    await updateProfileAvatar();
                    if (data.isAdmin) {
                        window.location.href = '/admin/admin-panel.html';
                    } else {
                        window.location.reload();
                    }
                } else {
                    errorEl.textContent = data.error || 'GiriÅŸ baÅŸarÄ±sÄ±z';
                }
            } catch (error) {
                errorEl.textContent = 'Sunucuyla baÄŸlantÄ± hatasÄ±';
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            const username = document.getElementById('signup-username').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const passwordConfirm = document.getElementById('signup-password-confirm').value;
            const errorEl = document.getElementById('signup-error');
            const strongPasswordRegex = /^(?=.*[a-z])(?!.*[ÄŸÃ¼ÅŸÃ¶Ã§Ä±])(?=.*[A-Z])(?!.*[ÄžÃœÅžÃ–Ã‡Ä°])(?=.*\d)[A-Za-z\d]{8,}$/;

            if (!strongPasswordRegex.test(password)) {
                errorEl.textContent = 'Parola en az 8 karakter, 1 bÃ¼yÃ¼k harf, 1 kÃ¼Ã§Ã¼k harf ve 1 rakam iÃ§ermelidir.';
                return;
            }
            if (password !== passwordConfirm) {
                errorEl.textContent = 'Parolalar eÅŸleÅŸmiyor';
                return;
            }
            try {
                const res = await fetch(`${apiUrl}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                const data = await res.json();
                if (res.ok) {
                    const loginRes = await fetch(`${apiUrl}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const loginData = await loginRes.json();
                    if (loginRes.ok) {
                        localStorage.setItem('token', loginData.token);
                        localStorage.setItem('username', loginData.username);
                        isLoggedIn = true;
                        currentUser = loginData.username;
                        closeAuthModal();
                        await updateProfileAvatar();
                        window.location.reload();
                    } else {
                        errorEl.textContent = loginData.error || 'Otomatik giriÅŸ baÅŸarÄ±sÄ±z';
                    }
                } else {
                    errorEl.textContent = data.error || 'KayÄ±t baÅŸarÄ±sÄ±z';
                }
            } catch (error) {
                errorEl.textContent = 'Sunucuyla baÄŸlantÄ± hatasÄ±';
            }
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            const email = document.getElementById('forgot-email').value;
            const errorEl = document.getElementById('forgot-error');
            const successEl = document.getElementById('forgot-success');
            try {
                const res = await fetch(`${apiUrl}/api/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                if (res.ok) {
                    successEl.textContent = 'Åžifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ± e-postanÄ±za gÃ¶nderildi.';
                    errorEl.textContent = '';
                } else {
                    errorEl.textContent = data.error || 'Åžifre sÄ±fÄ±rlama baÅŸarÄ±sÄ±z';
                    successEl.textContent = '';
                }
            } catch (error) {
                errorEl.textContent = 'Sunucuyla baÄŸlantÄ± hatasÄ±';
                successEl.textContent = '';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            isLoggedIn = false;
            currentUser = null;
            updateProfileAvatar();
            window.location.href = '/';
        }

        function getSeriesIdFromDynamicUrl() {
            const match = window.location.pathname.match(/^\/dizi\/([^\/]+)(?:\/sezon-(\d+)\/bolum-(\d+))?/);
            if (!match) return null;
           return {
  id: match[1],
  season: match[2] ? parseInt(match[2]) : null,
  episode: match[3] ? parseInt(match[3]) : null
};

        }

        async function fetchSeriesById(id) {
            try {
                const res = await fetch(`${apiUrl}/api/movies/${id}`);
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'Dizi bulunamadÄ±');
                }
                return await res.json();
            } catch (error) {
                console.error('Fetch series error:', error.message);
                return null;
            }
        }

        function displayErrorPage() {
            const container = document.getElementById('dizi-container');
            container.innerHTML = `
                <div class="error-container">
                    <i class="fas fa-exclamation-circle error-icon"></i>
                    <h2>ÃœzgÃ¼nÃ¼z, Dizi BulunamadÄ±</h2>
                    <p>AradÄ±ÄŸÄ±nÄ±z dizi arÅŸivimizde bulunmamÄ±ÅŸtÄ±r.</p>
                    <a href="/" class="home-button">Ana Sayfaya DÃ¶n</a>
                    <p>Veya<br> <a href="/request-complaint.html" class="home-button">Ä°stekte Bulunun</a></p>
                </div>
            `;
            document.getElementById('player-container').style.display = 'none';
            document.getElementById('season-section').style.display = 'none';
            document.getElementById('similar-series').style.display = 'none';
            document.getElementById('loading-screen').classList.add('hidden');
        }

        function displaySeriesDetails(series) {
            const container = document.getElementById('dizi-container');
            const hero = document.createElement('div');
            hero.className = 'series-hero';

            const posterWrapper = document.createElement('div');
            posterWrapper.className = 'poster-wrapper';

            const poster = document.createElement('img');
            poster.className = 'series-poster';
            poster.src = series.poster || 'https://via.placeholder.com/300x450';
            poster.alt = series.title;

            const premiumIcon = series.premium ? '<i class="fas fa-crown premium-icon"></i>' : '';
            posterWrapper.innerHTML = premiumIcon;
            posterWrapper.appendChild(poster);

            const info = document.createElement('div');
            info.className = 'series-info';

            const title = document.createElement('h1');
title.className = 'series-title';
title.textContent = series.title || 'Bilinmeyen Dizi';
info.appendChild(title);
updateSeriesTitle(series); // sadece <title> deÄŸiÅŸsin

            const current = getSeriesIdFromDynamicUrl();
            
if (!current.season && !current.episode) {
  // Sezon & bÃ¶lÃ¼m yoksa, genel description
  setDynamicDescription(series);
}
if (current && current.season && current.episode && series.episodes) {
  const ep = series.episodes.find(e => e.seasonNumber == current.season && e.episodeNumber == current.episode);
  if (ep) setDynamicDescription(series, ep);
}




            const meta = document.createElement('div');
            meta.className = 'series-meta';
            meta.appendChild(createMetaItem('calendar', series.year || 'N/A'));

            const seasonCount = series.episodes 
                ? [...new Set(series.episodes.map(ep => ep.seasonNumber))].length 
                : 0;
            if (seasonCount > 0) {
                meta.appendChild(createMetaItem('layer-group', `${seasonCount} Sezon`));
            }

            if (series.runtime) {
                meta.appendChild(createMetaItem('clock', series.runtime));
            }
            meta.appendChild(createMetaItem('star', series.rating || 'N/A'));
            if (series.country?.[0]) {
                meta.appendChild(createMetaItem('globe', series.country[0].charAt(0).toUpperCase() + series.country[0].slice(1).toLowerCase()));
            }

            const genres = document.createElement('div');
            genres.className = 'series-genres';
            if (Array.isArray(series.genres)) {
                series.genres.forEach(genre => {
                    const genreDiv = document.createElement('div');
                    genreDiv.className = 'series-genre';
                    genreDiv.textContent = genre;
                    genreDiv.onclick = () => searchByGenre(genre);
                    genres.appendChild(genreDiv);
                });
            }

            const languages = document.createElement('div');
            languages.className = 'series-languages';
            if (Array.isArray(series.language)) {
                series.language.forEach(lang => {
                    const langDiv = document.createElement('div');
                    langDiv.className = 'series-language';
                    if (lang === "TÃ¼rkÃ§e Dublaj") {
                        langDiv.innerHTML = `<img src="/resim/flag-tr.png" alt="TR" class="flag-icon"> Dublaj`;
                    } else if (lang === "TÃ¼rkÃ§e AltyazÄ±") {
                        langDiv.innerHTML = `<i class="fas fa-closed-captioning"></i> AltyazÄ±`;
                    } else if (lang === "Yerli") {
                        langDiv.innerHTML = `<img src="/resim/flag-tr.png" alt="TR" class="flag-icon"> Yerli`;
                    } else {
                        langDiv.textContent = lang;
                    }
                    languages.appendChild(langDiv);
                });
            }

            const plot = document.createElement('div');
            plot.className = 'series-plot';
            plot.innerHTML = `<strong>Konusu:</strong> ${series.plot || 'Konu bilgisi mevcut deÄŸil.'}`;

            info.append(title, meta, genres, languages, plot);
            hero.append(posterWrapper, info);
            container.innerHTML = '';
            container.appendChild(hero);
        }

        function searchByGenre(genre) {
    const encodedGenre = encodeURIComponent(genre);
    window.location.href = `/kesfet?genre=${encodedGenre}`;
}

        function createMetaItem(icon, text) {
            const item = document.createElement('div');
            item.className = 'series-meta-item';
            item.innerHTML = `<i class="fas fa-${icon}"></i> ${text}`;
            return item;
        }

        async function watchSeries(seriesId, seriesTitle, seasonNumber = 1, episodeNumber = 1) {
            const playerContainer = document.getElementById('player-container');
            playerContainer.innerHTML = '';

            let isLiked = false;
            let isDisliked = false;
            let isWatched = false;
            let isFavorited = false;
            let isWatchLater = false;
            let likeCount = 0;
            let dislikeCount = 0;
try {
  const favRes = await fetch(`${apiUrl}/api/movie-status/${seriesId}`, {
    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
  });
  if (favRes.ok) {
    const favData = await favRes.json();
    isFavorited = favData.isFavorited;
    isWatchLater = favData.isWatchLater; // ðŸ‘ˆ buraya eklendi!
  }
} catch (error) {
  console.error('Favori durumu alÄ±namadÄ±:', error);
}


if (!seriesId || !seasonNumber || !episodeNumber) {
  console.warn("Eksik parametre ile watchSeries Ã§aÄŸrÄ±sÄ± engellendi.");
  return;
}


            if (isLoggedIn) {
                try {
                    const res = await fetch(`${apiUrl}/api/status/${seriesId}/${seasonNumber}/${episodeNumber}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        isLiked = data.isLiked;
                        isDisliked = data.isDisliked;
                        isWatched = data.isWatched;
                        likeCount = data.likeCount;
                        dislikeCount = data.dislikeCount;
                    }

                    const favRes = await fetch(`${apiUrl}/api/movie-status/${seriesId}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (favRes.ok) {
                        const favData = await favRes.json();
                        isFavorited = favData.isFavorited;
                    }
                } catch (error) {
                    console.error('Status fetch error:', error);
                }
            } else {
                try {
                    const res = await fetch(`${apiUrl}/api/public/status/${seriesId}/${seasonNumber}/${episodeNumber}`);
                    if (res.ok) {
                        const data = await res.json();
                        likeCount = data.likeCount;
                        dislikeCount = data.dislikeCount;
                    }
                } catch (error) {
                    console.error('Public status fetch error:', error);
                }
            }

            const episode = seriesCache.episodes?.find(ep => ep.seasonNumber === seasonNumber && ep.episodeNumber === episodeNumber);
            const videoSrc = episode?.videoSrc?.[0]?.src || 'about:blank';
            const episodeTitle = episode?.title || '';

            playerContainer.innerHTML = `
                <div class="player-box">
                    <div class="player-title">
  <h2 class="series-name">
  <a href="/dizi/${seriesId}" style="color: inherit; text-decoration: none;">${seriesTitle || 'Bilinmeyen Dizi'}</a>
</h2>

  <button title="Favorilere Ekle" class="favorite-btn ${isLoggedIn ? '' : 'disabled'} ${isFavorited ? 'active' : ''}" id="favorite-btn-${seriesId}" 
           ${isFavorited ? 'red' : '#fff'}">
    <i class="${isFavorited ? 'fas' : 'far'} fa-heart"></i>
  </button>

 <button title="Daha Sonra Ä°zle" class="watchLaterBtn  ${isLoggedIn ? '' : 'disabled'} ${isWatchLater ? 'active' : ''}" id="watchLaterBtn-${seriesId}">
  <i class="${isWatchLater ? 'fas' : 'far'} fa-clock"></i>
</button>

  
</div>

<p class="episode-info">Sezon ${seasonNumber} BÃ¶lÃ¼m ${episodeNumber}${episodeTitle ? ` ` : ''}</p>


                    ${seriesCache.premium && !isPremiumUser ? `
                        <div class="premium-message">
                            <i class="fas fa-lock"></i>
                            <p>Ä°Ã§erik Telifli OlduÄŸu Ä°Ã§in Premium Ãœyelik SatÄ±n AlÄ±nÄ±z</p>
                            <button onclick="window.location.href='/premium.html'">Ãœyelik SatÄ±n Al</button>
                        </div>
                    ` : `
                        <div class="video-options" id="video-options"></div>
                        <div id="series-player-container" class="video-wrapper">
  <img src="/resim/dizit-logo.png" class="player-overlay-logo" alt="Logo">
</div>



                        <div class="player-actions">
                            <button class="like-btn ${isLoggedIn ? '' : 'disabled'} ${isLiked ? 'active' : ''}" id="like-btn-${seriesId}-${seasonNumber}-${episodeNumber}">
                                <i class="${isLiked ? 'fas' : 'far'} fa-thumbs-up"></i> BeÄŸen: ${likeCount}
                            </button>
                            <button class="dislike-btn ${isLoggedIn ? '' : 'disabled'} ${isDisliked ? 'active' : ''}" id="dislike-btn-${seriesId}-${seasonNumber}-${episodeNumber}">
                                <i class="${isDisliked ? 'fas' : 'far'} fa-thumbs-down"></i> BeÄŸenme: ${dislikeCount}
                            </button>
                            <label class="watched-checkbox ${isLoggedIn ? '' : 'disabled'}">
                                <input type="checkbox" id="watched-checkbox-${seriesId}-${seasonNumber}-${episodeNumber}" ${isWatched ? 'checked' : ''} ${isLoggedIn ? '' : 'disabled'}>
                                <span class="checkbox-custom"></span>
                                Ä°zledim
                            </label>
                        </div>
                    `}
                </div>
            `;
            // â€¦Â playerContainer.innerHTML = ` â€¦videowrapperâ€¦ `;
createPlayer(videoSrc);   // <<< ekle


            if (!(seriesCache.premium && !isPremiumUser)) {
                const videoOptions = document.getElementById('video-options');
                if (episode?.videoSrc && Array.isArray(episode.videoSrc)) {
                    episode.videoSrc.forEach((src, index) => {
                        const btn = document.createElement('button');
                        btn.className = `video-option-btn ${index === 0 ? 'active' : ''}`;
                        if (src.type.includes("Dublaj") && src.type.includes("AltyazÄ±")) {
                            btn.innerHTML = `<span class="icon-left"><img src="/resim/flag-tr.png" alt="TR" class="flag-icon"><i class="fas fa-closed-captioning"></i></span> Dublaj ve AltyazÄ±`;
                        } else {
                            btn.innerHTML = src.type.includes("Dublaj") ? `<img src="/resim/flag-tr.png" alt="TR" class="flag-icon"> Dublaj` :
                                            src.type.includes("AltyazÄ±") ? `<i class="fas fa-closed-captioning"></i> AltyazÄ±` :
                                            src.type.includes("Yerli") ? `<img src="/resim/flag-tr.png" alt="TR" class="flag-icon"> Yerli` : src.type;
                        }
                       btn.onclick = () => {
    document.querySelectorAll('.video-option-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // HLS dosyasÄ± mÄ± kontrol et
    const isFile = /\.(m3u8|mp4|webm|mov|flv|mkv|ogg)(\?.*)?$/.test(src.src.toLowerCase());
    
    // OynatÄ±cÄ±yÄ± yeniden oluÅŸtur
    createPlayer(src.src);
};

                        videoOptions.appendChild(btn);
                    });
                }
            }
updateSeriesTitle(seriesCache);

            const likeBtn = document.getElementById(`like-btn-${seriesId}-${seasonNumber}-${episodeNumber}`);
            const dislikeBtn = document.getElementById(`dislike-btn-${seriesId}-${seasonNumber}-${episodeNumber}`);
            const favoriteBtn = document.getElementById(`favorite-btn-${seriesId}`);
            const watchedCheckbox = document.getElementById(`watched-checkbox-${seriesId}-${seasonNumber}-${episodeNumber}`);
      const watchLaterBtn = document.getElementById(`watchLaterBtn-${seriesId}`);
if (watchLaterBtn) {
  watchLaterBtn.addEventListener('click', async () => {
    if (!isLoggedIn) {
      openAuthModal('login');
      return;
    }

    try {
      const res = await fetch(`${apiUrl}/api/watch-later`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ movieId: seriesId })
      });

      const data = await res.json();
      const icon = watchLaterBtn.querySelector('i');
      const isNowWatchLater = data.isWatchLater;

      watchLaterBtn.classList.toggle('active', isNowWatchLater);
      icon.classList.toggle('fas', isNowWatchLater);
      icon.classList.toggle('far', !isNowWatchLater);

      // âœ… Toast bildirimi
      showToast(isNowWatchLater ? 'Dizi "Daha Sonra Ä°zle" listesine eklendi.' : 'Dizi listeden Ã§Ä±karÄ±ldÄ±.');
    } catch (err) {
      console.error('Watch Later error:', err);
      showToast('Ä°ÅŸlem sÄ±rasÄ±nda hata oluÅŸtu.', 'error');
    }
  });
}



            likeBtn.addEventListener('click', async () => {
                if (!isLoggedIn) {
                    openAuthModal('login');
                    return;
                }
                try {
                    const res = await fetch(`${apiUrl}/api/like`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ seriesId, seasonNumber, episodeNumber })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        likeBtn.classList.toggle('active', data.isLiked);
                        dislikeBtn.classList.toggle('active', data.isDisliked);
                        likeBtn.innerHTML = `<i class="${data.isLiked ? 'fas' : 'far'} fa-thumbs-up"></i> BeÄŸen: ${data.likeCount}`;
                        dislikeBtn.innerHTML = `<i class="${data.isDisliked ? 'fas' : 'far'} fa-thumbs-down"></i> BeÄŸenme: ${data.dislikeCount}`;
                        showToast(data.isLiked ? 'BÃ¶lÃ¼m beÄŸenildi!' : 'BeÄŸeni kaldÄ±rÄ±ldÄ±.', 'success');
                    } else {
                        showToast(data.error || 'BeÄŸeni iÅŸlemi baÅŸarÄ±sÄ±z', 'error');
                        if (data.error.includes('token')) logout();
                    }
                } catch (error) {
                    showToast('Sunucuyla baÄŸlantÄ± hatasÄ±', 'error');
                }
            });

            dislikeBtn.addEventListener('click', async () => {
                if (!isLoggedIn) {
                    openAuthModal('login');
                    return;
                }
                try {
                    const res = await fetch(`${apiUrl}/api/dislike`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ seriesId, seasonNumber, episodeNumber })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        dislikeBtn.classList.toggle('active', data.isDisliked);
                        likeBtn.classList.toggle('active', data.isLiked);
                        likeBtn.innerHTML = `<i class="${data.isLiked ? 'fas' : 'far'} fa-thumbs-up"></i> BeÄŸen: ${data.likeCount}`;
                        dislikeBtn.innerHTML = `<i class="${data.isDisliked ? 'fas' : 'far'} fa-thumbs-down"></i> BeÄŸenme: ${data.dislikeCount}`;
                        showToast(data.isDisliked ? 'BÃ¶lÃ¼m beÄŸenilmedi!' : 'BeÄŸenmeme kaldÄ±rÄ±ldÄ±.', 'success');
                    } else {
                        showToast(data.error || 'BeÄŸenmeme iÅŸlemi baÅŸarÄ±sÄ±z', 'error');
                        if (data.error.includes('token')) logout();
                    }
                } catch (error) {
                    showToast('Sunucuyla baÄŸlantÄ± hatasÄ±', 'error');
                }
            });

            favoriteBtn.addEventListener('click', async () => {
                if (!isLoggedIn) {
                    openAuthModal('login');
                    return;
                }
                try {
                    const res = await fetch(`${apiUrl}/api/favorite`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ movieId: seriesId })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        favoriteBtn.classList.toggle('active', data.isFavorited);
                        favoriteBtn.innerHTML = `<i class="${data.isFavorited ? 'fas' : 'far'} fa-heart"></i>`;

                        showToast(data.isFavorited ? 'Dizi favorilere eklendi!' : 'Dizi favorilerden Ã§Ä±karÄ±ldÄ±.', 'success');
                    } else {
                        showToast(data.error || 'Favori iÅŸlemi baÅŸarÄ±sÄ±z', 'error');
                        if (data.error.includes('token')) logout();
                    }
                } catch (error) {
                    showToast('Sunucuyla baÄŸlantÄ± hatasÄ±', 'error');
                }
            });

            watchedCheckbox.addEventListener('change', async () => {
                if (!isLoggedIn) {
                    openAuthModal('login');
                    watchedCheckbox.checked = false;
                    return;
                }
                try {
                    const res = await fetch(`${apiUrl}/api/watched`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ seriesId, seasonNumber, episodeNumber })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        showToast(data.isWatched ? 'Ä°zledi olarak iÅŸaretlendi!' : 'Ä°zlenme durumu kaldÄ±rÄ±ldÄ±.', 'success');
                        updateEpisodeCard(seriesId, seasonNumber, episodeNumber, data.isWatched);
                    } else {
                        showToast(data.error || 'Ä°zleme durumu gÃ¼ncellenemedi', 'error');
                        watchedCheckbox.checked = !watchedCheckbox.checked;
                    }
                } catch (error) {
                    showToast('Sunucuyla baÄŸlantÄ± hatasÄ±', 'error');
                    watchedCheckbox.checked = !watchedCheckbox.checked;
                }
            });

            window.scrollTo({ top: playerContainer.offsetTop - 100, behavior: 'smooth' });

            const newUrl = `/dizi/${seriesId}/sezon-${seasonNumber}/bolum-${episodeNumber}`;
            if (window.location.pathname !== newUrl) {
                history.pushState({ seriesId, seasonNumber, episodeNumber }, '', newUrl);
            }
        }

        function displaySeasonSelector(series) {
            const seasonSection = document.getElementById('season-section');
            if (!series.episodes || !Array.isArray(series.episodes) || series.episodes.length === 0) {
                seasonSection.style.display = 'none';
                return;
            }

            const seasons = {};
            series.episodes.forEach(episode => {
                if (!seasons[episode.seasonNumber]) {
                    seasons[episode.seasonNumber] = [];
                }
                seasons[episode.seasonNumber].push(episode);
            });

            const sortedSeasons = Object.keys(seasons)
                .map(Number)
                .sort((a, b) => a - b)
                .map(seasonNumber => ({
                    seasonNumber,
                    episodes: seasons[seasonNumber].sort((a, b) => a.episodeNumber - b.episodeNumber)
                }));

            seriesCache.seasons = sortedSeasons;

            seasonSection.innerHTML = `
                <div class="season-selector">
                    <select id="season-select">
                        ${sortedSeasons.map((season, index) => `
                            <option value="${season.seasonNumber}" ${index === 0 ? 'selected' : ''}>Sezon ${season.seasonNumber}</option>
                        `).join('')}
                    </select>
                </div>
                <div class="episode-list" id="episode-list"></div>
            `;

            const seasonSelect = document.getElementById('season-select');
            seasonSelect.addEventListener('change', () => {
                const selectedSeasonNumber = parseInt(seasonSelect.value);
                const selectedSeason = sortedSeasons.find(s => s.seasonNumber === selectedSeasonNumber);
                displayEpisodes(series.id, selectedSeason.episodes, selectedSeasonNumber);
            });

            const urlData = getSeriesIdFromDynamicUrl();
            const initialSeason = urlData?.season || sortedSeasons[0]?.seasonNumber || 1;
            seasonSelect.value = initialSeason;
            const selectedSeason = sortedSeasons.find(s => s.seasonNumber === initialSeason);
            displayEpisodes(series.id, selectedSeason.episodes, initialSeason);
        }

        async function displayEpisodes(seriesId, episodes, seasonNumber) {
            const episodeList = document.getElementById('episode-list');
            episodeList.innerHTML = '';

            if (!episodes || episodes.length === 0) {
                episodeList.innerHTML = '<p>Bu sezona ait bÃ¶lÃ¼m bulunamadÄ±.</p>';
                return;
            }

            let batchStatus = [];
            if (isLoggedIn) {
                try {
                    const res = await fetch(`${apiUrl}/api/batch-status`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            seriesId,
                            episodes: episodes.map(ep => ({
                                seasonNumber: ep.seasonNumber,
                                episodeNumber: ep.episodeNumber
                            }))
                        })
                    });
                    if (res.ok) {
                        batchStatus = await res.json();
                    }
                } catch (error) {
                    console.error('Batch status fetch error:', error);
                }
            }

            const urlData = getSeriesIdFromDynamicUrl();
            const currentEpisode = urlData?.episode || null;

            episodes.forEach((episode, index) => {
                const episodeNumber = episode.episodeNumber;
                const status = batchStatus.find(s => s.seasonNumber === seasonNumber && s.episodeNumber === episodeNumber) || {};
                const isWatched = status.isWatched || false;

                const card = document.createElement('div');
                card.className = `episode-card ${episodeNumber === currentEpisode ? 'active' : ''}`;
                card.style.backgroundImage = `url('${seriesCache.poster || 'https://via.placeholder.com/150'}')`;
                card.style.backgroundSize = 'cover';
                card.style.backgroundPosition = 'center';
                card.innerHTML = `
                    <div class="episode-overlay">
                        <div class="episode-info">
                            <span class="episode-number">Sezon ${seasonNumber} BÃ¶lÃ¼m ${episodeNumber}</span>
                        </div>
                        <button class="play-btn">
                            <i class="fas fa-play"></i>
                            ${seriesCache.premium && !isPremiumUser ? '<i class="fas fa-lock lock-icon"></i>' : ''}
                        </button>
                        ${isWatched ? '<i class="fas fa-check-circle watched-icon"></i>' : ''}
                    </div>
                `;
                card.onclick = () => {
    window.location.href = `/dizi/${seriesId}/sezon-${seasonNumber}/bolum-${episodeNumber}`;
};

                episodeList.appendChild(card);
            });
        }

        function updateEpisodeCard(seriesId, seasonNumber, episodeNumber, isWatched) {
            const episodeCards = document.querySelectorAll('.episode-card');
            episodeCards.forEach(card => {
                const episodeInfo = card.querySelector('.episode-number').textContent;
                const match = episodeInfo.match(/Sezon (\d+) BÃ¶lÃ¼m (\d+)/);
                if (match && parseInt(match[1]) === seasonNumber && parseInt(match[2]) === episodeNumber) {
                    const watchedIcon = card.querySelector('.watched-icon');
                    if (isWatched && !watchedIcon) {
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-check-circle watched-icon';
                        card.querySelector('.episode-overlay').appendChild(icon);
                    } else if (!isWatched && watchedIcon) {
                        watchedIcon.remove();
                    }
                }
            });
        }

        async function displaySimilarSeries(currentSeries) {
            const container = document.getElementById('similar-series');
            container.innerHTML = `
                <h2 class="section-title">Ã–nerilen Diziler</h2>
                <div class="poster-slider" id="similar-slider">
                    <div class="slider-container" id="similar-slider-container">
                        <p>YÃ¼kleniyor...</p>
                    </div>
                    <button class="slider-prev" id="similar-prev"><i class="fas fa-chevron-left"></i></button>
                    <button class="slider-next" id="similar-next"><i class="fas fa-chevron-right"></i></button>
                </div>
            `;

            try {
                const token = localStorage.getItem('token');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                const res = await fetch(`${apiUrl}/api/similar/${currentSeries.id}?type=dizi`, { headers });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'Ã–nerilen diziler alÄ±namadÄ±');
                }
                const series = await res.json();
                if (!Array.isArray(series) || series.length === 0) {
                    document.getElementById('similar-slider-container').innerHTML = '<p>Ã–nerilen dizi bulunamadÄ±.</p>';
                    return;
                }
                displayItems(series, 'similar-slider-container');
            } catch (error) {
                console.error('Similar series error:', error.message);
                document.getElementById('similar-slider-container').innerHTML = '<p>Ã–nerilen diziler yÃ¼klenemedi.</p>';
                showToast('Ã–nerilen diziler yÃ¼klenemedi', 'error');
            }
        }

        function displayItems(items, containerId, isSlider = true, isEpisode = false) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            if (!items || !Array.isArray(items) || items.length === 0) {
                container.innerHTML = '<p>Ä°Ã§erik bulunamadÄ±.</p>';
                return;
            }

            items.forEach(item => {
                const premiumIcon = item.premium ? '<i class="fas fa-crown premium-icon"></i>' : '';
                const card = document.createElement('div');
                card.className = isEpisode ? 'episode-card' : (isSlider ? 'slider-item' : 'movie-card');
                
                if (isEpisode) {
                    const seriesTitle = item.seriesTitle || 'BaÅŸlÄ±k Yok';
                    const episodeDetails = `${seriesTitle} ${item.seasonNumber}.Sezon ${item.episodeNumber}.BÃ¶lÃ¼m`;
                    card.innerHTML = `
                        <img src="${item.poster || 'https://via.placeholder.com/60x90'}" alt="${seriesTitle}" class="episode-poster">
                        <div class="episode-info">
                            <h3 class="episode-series-title">${episodeDetails}</h3>
                            <div class="episode-details">YÄ±l: ${item.year || 'N/A'} | Puan: ${item.rating || 'N/A'}</div>
                        </div>
                        ${premiumIcon}
                    `;
                    card.onclick = () => window.location.href = `/dizi/${item.seriesId}/sezon-${item.seasonNumber}/bolum-${item.episodeNumber}`;
                } else {
                    const title = item.title || 'BaÅŸlÄ±k Yok';
                    const badge = item.language?.includes("Yerli") ? '<span class="language-badge"><img src="/resim/flag-tr.png" alt="TR" class="flag-icon"> Yerli</span>' :
                                 item.language?.includes("TÃ¼rkÃ§e Dublaj") && item.language?.includes("TÃ¼rkÃ§e AltyazÄ±") ? '<span class="language-badge"><img src="/resim/flag-tr.png" alt="TR" class="flag-icon"> Dublaj <i class="fas fa-closed-captioning"></i> AltyazÄ±</span>' :
                                 item.language?.includes("TÃ¼rkÃ§e Dublaj") ? '<span class="language-badge"><img src="/resim/flag-tr.png" alt="TR" class="flag-icon"> Dublaj</span>' :
                                 item.language?.includes("TÃ¼rkÃ§e AltyazÄ±") ? '<span class="language-badge"><i class="fas fa-closed-captioning"></i> AltyazÄ±</span>' : '';
                    card.innerHTML = `
                        <div class="poster-wrapper">
                            <img src="${item.poster || 'https://via.placeholder.com/300x450'}" alt="${title}" class="${isSlider ? 'slider-poster' : 'movie-poster'}">
                            ${badge}
                            ${premiumIcon}
                        </div>
                        <div class="${isSlider ? 'slider-info' : 'movie-info'}">
                            <h3 class="${isSlider ? 'slider-title' : 'movie-title'}">${title}</h3>
                            <div class="${isSlider ? 'slider-meta' : 'movie-meta'}">
                                <span>${item.year || 'Bilinmiyor'}</span>
                                <div class="imdb-rating">
                                    <i class="fas fa-star"></i> ${item.rating || 'N/A'}
                                </div>
                            </div>
                        </div>
                    `;
                    card.onclick = () => window.location.href = `/dizi/${item.id}`;
                }
                container.appendChild(card);
            });

            if (isSlider) {
                initSlider('similar-slider-container', 'similar-prev', 'similar-next');
            }
        }

        function initSlider(sliderId, prevBtnId, nextBtnId) {
            const container = document.getElementById(sliderId);
            const prevBtn = document.getElementById(prevBtnId);
            const nextBtn = document.getElementById(nextBtnId);
            let isDragging = false;
            let startX = 0;
            let scrollLeft = 0;

            function updateButtons() {
                prevBtn.style.display = container.scrollLeft <= 0 ? 'none' : 'block';
                nextBtn.style.display = container.scrollLeft >= container.scrollWidth - container.clientWidth - 1 ? 'none' : 'block';
            }

            const scrollStep = 220;
            nextBtn.onclick = () => {
                container.scrollTo({
                    left: container.scrollLeft + scrollStep,
                    behavior: 'smooth'
                });
                setTimeout(updateButtons, 300);
            };

            prevBtn.onclick = () => {
                container.scrollTo({
                    left: container.scrollLeft - scrollStep,
                    behavior: 'smooth'
                });
                setTimeout(updateButtons, 300);
            };

            container.addEventListener('touchstart', e => {
                isDragging = true;
                startX = e.touches[0].clientX;
                scrollLeft = container.scrollLeft;
            });

            container.addEventListener('touchmove', e => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.touches[0].clientX;
                const deltaX = x - startX;
                container.scrollLeft = scrollLeft - deltaX;
            });

            container.addEventListener('touchend', () => {
                isDragging = false;
            });

            container.addEventListener('wheel', e => {
                e.preventDefault();
                container.scrollTo({
                    left: container.scrollLeft + e.deltaY * 2,
                    behavior: 'smooth'
                });
                setTimeout(updateButtons, 200);
            });

            container.addEventListener('scroll', updateButtons);
            updateButtons();
        }

        async function performSearch(query) {
            const searchResults = document.getElementById('search-results');
            if (!query) {
                searchResults.innerHTML = '';
                return;
            }
            try {
                const res = await fetch(`${apiUrl}/api/search?q=${encodeURIComponent(query)}&limit=7&fields=title,title2,type,poster,year,rating,genres,premium`);
                if (!res.ok) throw new Error('Arama baÅŸarÄ±sÄ±z');
                let data = await res.json();
                data = data.filter(item => 
                    item.title?.toLowerCase().includes(query.toLowerCase()) || 
                    item.title2?.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 7);
                displaySearchResults(data);
            } catch (error) {
                searchResults.innerHTML = '<p>SonuÃ§ bulunamadÄ±.</p>';
                showToast('Arama baÅŸarÄ±sÄ±z', 'error');
            }
        }

        function displaySearchResults(results) {
            const searchResults = document.getElementById('search-results');
            searchResults.innerHTML = results.length ? '' : '<p>SonuÃ§ bulunamadÄ±.</p>';
            results.forEach(item => {
                const premiumIcon = item.premium ? '<i class="fas fa-crown premium-icon"></i>' : '';
                const itemEl = document.createElement('div');
                itemEl.className = 'search-result-item';
                itemEl.innerHTML = `
                    <div class="poster-wrapper">
                        <img src="${item.poster || 'https://via.placeholder.com/150'}" alt="${item.title}" class="search-result-poster">
                        ${premiumIcon}
                    </div>
                    <div class="search-result-info">
                        <div class="search-result-title">
                            ${item.title || 'Bilinmeyen Ä°Ã§erik'}
                            ${item.title2 ? `<span class="search-result-title2">(${item.title2})</span>` : ''}
                        </div>
                        <div class="search-result-year">${item.year || 'N/A'}</div>
                        <div class="search-result-genres">${Array.isArray(item.genres) ? item.genres.join(', ') : 'N/A'}</div>
                    </div>
                `;
                itemEl.onclick = () => window.location.href = item.type === 'dizi' ? `/dizi/${item.id}` : `/film/${item.id}`;
                searchResults.appendChild(itemEl);
            });
        }

        async function init() {
            await fetchApiUrl();
            await checkAuth();
            await checkPremiumStatus();

            let urlData = getSeriesIdFromDynamicUrl();
           if (!urlData?.id) {
  const urlParams = new URLSearchParams(window.location.search);
  const seriesId = urlParams.get('id');
  if (seriesId) {
    const newUrl = `/dizi/${seriesId}`;
    window.location.replace(newUrl);
    return;
  }
  displayErrorPage();
  return;
}



            const series = await fetchSeriesById(urlData.id);
            if (!series) {
                displayErrorPage();
                return;
            }

            seriesCache = series;
            displaySeriesDetails(series);
            displaySeasonSelector(series);
            displaySimilarSeries(series);
          
if (urlData.season && urlData.episode) {
    watchSeries(series.id, series.title, urlData.season, urlData.episode);
}

           

            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.classList.add('hidden');
            setTimeout(() => loadingScreen.remove(), 500);

            document.getElementById('search-input').onfocus = () => {
                const overlay = document.getElementById('search-overlay');
                overlay.classList.add('active');
                document.getElementById('search-overlay-input').focus();
            };

            document.getElementById('search-overlay-input').oninput = () => {
                const query = document.getElementById('search-overlay-input').value.trim().toLowerCase();
                performSearch(query);
            };

            document.getElementById('close-overlay').onclick = () => {
                const overlay = document.getElementById('search-overlay');
                overlay.classList.remove('active');
                document.getElementById('search-input').value = '';
                document.getElementById('search-overlay-input').value = '';
                document.getElementById('search-results').innerHTML = '';
            };

            document.getElementById('burger-menu').onclick = () => {
                document.getElementById('nav-container').classList.toggle('active');
            };

            window.addEventListener('resize', () => {
                if (window.innerWidth > 768 && document.getElementById('nav-container').classList.contains('active')) {
                    document.getElementById('nav-container').classList.remove('active');
                }
            });

            document.addEventListener('click', (event) => {
                const dropdown = document.getElementById('profile-dropdown');
                const profileCard = document.querySelector('.profile-card');
                if (!dropdown.contains(event.target) && !profileCard.contains(event.target)) {
                    closeProfileMenu();
                }
            });

            document.addEventListener('touchstart', (event) => {
                const dropdown = document.getElementById('profile-dropdown');
                const profileCard = document.querySelector('.profile-card');
                if (!dropdown.contains(event.target) && !profileCard.contains(event.target)) {
                    closeProfileMenu();
                }
            });

      window.addEventListener('popstate', () => {
    const data = getSeriesIdFromDynamicUrl();

    // URL sadece dizi sayfasÄ±nÄ± iÃ§eriyorsa
    if (data && data.id && !data.season && !data.episode) {
        displaySeriesDetails(seriesCache);
        displaySeasonSelector(seriesCache);
        displaySimilarSeries(seriesCache);
        document.getElementById('player-container').innerHTML = '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
    }

    // URL bÃ¶lÃ¼m iÃ§eriyorsa, sadece o zaman Ã§alÄ±ÅŸtÄ±r
    if (data && data.id && data.season && data.episode) {
        watchSeries(data.id, seriesCache?.title || '', data.season, data.episode);
    }
});


        }

        document.addEventListener('DOMContentLoaded', () => {
            init();
        });

        
        document.addEventListener('DOMContentLoaded', () => {
   function sendViewEvent() {
    const movieId = movieCache?._id; // Bu _id => MongoDB ObjectId

    if (!movieId) {
      console.warn("ðŸš« movieId bulunamadÄ±.");
      return;
    }

    fetch(`${apiUrl}/api/movies/${movieId}/view`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${localStorage.getItem("token")}`
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data?.views !== undefined) {
        console.log("âœ… GÃ¶rÃ¼ntÃ¼leme sayÄ±sÄ± gÃ¼ncellendi:", data.views);
      } else {
        console.warn("ðŸš« Ä°zlenme gÃ¶nderilemedi:", data?.error || "Bilinmeyen hata");
      }
    })
    .catch(err => console.error("ðŸš« Fetch hatasÄ±:", err));
  }

  // 5 saniye sonra izlenme saydÄ±r
  setTimeout(sendViewEvent, 5000);
});



function setDynamicDescription(series, episode = null) {
  const title = series.title || 'Bilinmeyen Dizi';
  const title2 = series.title2 ? ` (${series.title2})` : '';
  const year = series.year || 'N/A';
  const languages = series.language || [];
  const poster = series.poster || '/resim/default.jpg';
  const canonicalUrl = window.location.origin + window.location.pathname;


  let seasonText = '';
  if (episode) {
    seasonText = `${episode.seasonNumber}. Sezon ${episode.episodeNumber}. BÃ¶lÃ¼m`;
  }

  // AÃ§Ä±klama metni
  let descriptionText = episode
    ? `${title} ${seasonText} izle. ${title} dizisinin ${seasonText.toLowerCase()} bÃ¶lÃ¼mÃ¼ full HD ve tek parÃ§a olarak DÄ°ZÄ°T kalitesiyle izle.`
    : `${title} dizisini full HD izle. TÃ¼m sezon ve bÃ¶lÃ¼mleriyle tek parÃ§a DÄ°ZÄ°T kalitesinde hemen izle.`;

  // Dinamik language etiketleri
  let langParts = [];
  if (languages.includes("TÃ¼rkÃ§e Dublaj")) langParts.push("TÃ¼rkÃ§e DublajlÄ±");
  if (languages.includes("TÃ¼rkÃ§e AltyazÄ±")) langParts.push("TÃ¼rkÃ§e AltyazÄ±lÄ±");
  if (langParts.length === 0 && series.country?.includes("TÃ¼rkiye")) langParts.push("Yerli");
  if (langParts.length > 0) descriptionText += ` ${langParts.join(" ve ")}.`;

  // META: Description
  document.querySelector('meta[name="description"]')?.setAttribute("content", descriptionText);

  // META: Keywords
  const keywords = [
    title,
    title2.replace(/[()]/g, '').trim(),
    'dizi izle',
    'full hd dizi',
    'tek parÃ§a',
    ...(episode ? [seasonText + ' izle'] : []),
    ...languages
  ]
    .filter(Boolean)
    .map(k => k.toLowerCase())
    .join(', ');

  let metaKeywords = document.querySelector('meta[name="keywords"]');
  if (!metaKeywords) {
    metaKeywords = document.createElement('meta');
    metaKeywords.setAttribute('name', 'keywords');
    document.head.appendChild(metaKeywords);
  }
  metaKeywords.setAttribute('content', keywords);

  // LINK: Canonical
  let linkCanonical = document.querySelector('link[rel="canonical"]');
  if (!linkCanonical) {
    linkCanonical = document.createElement('link');
    linkCanonical.setAttribute('rel', 'canonical');
    document.head.appendChild(linkCanonical);
  }
  linkCanonical.setAttribute('href',  canonicalUrl);

  // Open Graph Meta Etiketleri
  const ogTags = {
    'og:title': episode
      ? `${seasonText} Ä°zle - ${title} - DÄ°ZÄ°T`
      : `${title} Ä°zle (${year}) - DÄ°ZÄ°T`,
    'og:description': descriptionText,
    'og:image': poster,
    'og:url': canonicalUrl,
    'og:type': episode ? 'video.episode' : 'video.tv_show',
  };

  Object.entries(ogTags).forEach(([property, content]) => {
    let metaTag = document.querySelector(`meta[property="${property}"]`);
    if (!metaTag) {
      metaTag = document.createElement('meta');
      metaTag.setAttribute('property', property);
      document.head.appendChild(metaTag);
    }
    metaTag.setAttribute('content', content);
  });

  // JSON-LD Structured Data
  let ld = {
    "@context": "https://schema.org",
    "@type": episode ? "TVEpisode" : "TVSeries",
    "name": episode ? seasonText : title,
    "description": descriptionText,
    "image": poster,
    "url": canonicalUrl
  };

  if (episode) {
    ld.episodeNumber = episode.episodeNumber;
    ld.partOfSeason = {
      "@type": "TVSeason",
      "seasonNumber": episode.seasonNumber
    };
    ld.partOfSeries = {
      "@type": "TVSeries",
      "name": title
    };
  }

  let ldScript = document.querySelector('script[type="application/ld+json"]');
  if (!ldScript) {
    ldScript = document.createElement('script');
    ldScript.type = 'application/ld+json';
    document.head.appendChild(ldScript);
  }
  ldScript.textContent = JSON.stringify(ld, null, 2);
}



function updateSeriesTitle(series) {
    const current = getSeriesIdFromDynamicUrl();

    // Sadece sayfa baÅŸlÄ±ÄŸÄ± deÄŸiÅŸtir
    if (current?.season && current?.episode) {
        document.title = `  ${series.title} - ${current.season}. Sezon ${current.episode}. BÃ¶lÃ¼m izle - DÄ°ZÄ°T`;
    } else {
        let titleText = series.title || 'Bilinmeyen Dizi';
        if (series.title2) {
            titleText += ` (${series.title2})`;
        }
        document.title = `${titleText} Ä°zle (${series.year || 'N/A'}) - DÄ°ZÄ°T`;
    }
}




    </script>
<script src="/playerJS/js/playerjs.js"></script>

</body>
</html>